{"version":3,"file":"AuditLogDialog.vue_vue_type_script_setup_true_lang-WkXOSlqa.js","sources":["../../../../../admin/src/components/auditlog/AuditLogDialog.vue"],"sourcesContent":["<template>\n    <v-dialog v-model=\"dialogVisible\" max-width=\"900\" scrollable>\n        <v-card>\n            <v-card-title class=\"d-flex align-center\">\n                <FontAwesomeIcon :icon=\"faClockRotateLeft\" class=\"mr-2\" />\n                {{ t(\"AuditLogTable.title\") }}\n                <v-spacer />\n                <v-btn icon variant=\"text\" @click=\"dialogVisible = false\">\n                    <FontAwesomeIcon :icon=\"faXmark\" />\n                </v-btn>\n            </v-card-title>\n            <v-divider />\n            <v-card-text class=\"pa-0\">\n                <v-data-table-server\n                    v-model:items-per-page=\"perPage\"\n                    v-model:expanded=\"expanded\"\n                    class=\"elevation-0\"\n                    item-value=\"id\"\n                    density=\"compact\"\n                    :headers=\"headers\"\n                    :items=\"entries\"\n                    :items-length=\"totalItems\"\n                    :loading=\"loading\"\n                    :page=\"currentPage\"\n                    :items-per-page-options=\"pageSizeOptions\"\n                    :no-data-text=\"t('AuditLogTable.noEntriesFound')\"\n                    :loading-text=\"t('AuditLogTable.loadingEntries')\"\n                    show-expand\n                    @update:options=\"loadData\"\n                >\n                    <template #item.timestamp=\"{ item }\">\n                        <DateTimeCell :value=\"item.timestamp\" />\n                    </template>\n                    <template #item.actor=\"{ item }\">\n                        {{ item.actor?.username ?? t(\"AuditLogTable.system\") }}\n                    </template>\n                    <template #item.action=\"{ item }\">\n                        <v-chip :color=\"actionColor(item.action)\" size=\"small\" variant=\"tonal\">\n                            {{ actionLabel(item.action) }}\n                        </v-chip>\n                    </template>\n                    <template #item.object_repr=\"{ item }\">\n                        <span class=\"text-truncate\" style=\"max-width: 200px; display: inline-block\">\n                            {{ item.object_repr }}\n                        </span>\n                    </template>\n                    <template #expanded-row=\"{ columns, item }\">\n                        <tr>\n                            <td :colspan=\"columns.length\" class=\"pa-4 bg-grey-lighten-4\">\n                                <DiffViewer :changes=\"item.changes\" />\n                            </td>\n                        </tr>\n                    </template>\n                </v-data-table-server>\n            </v-card-text>\n        </v-card>\n    </v-dialog>\n</template>\n\n<script setup lang=\"ts\">\nimport { faClockRotateLeft, faXmark } from \"@fortawesome/free-solid-svg-icons\";\nimport { FontAwesomeIcon } from \"@fortawesome/vue-fontawesome\";\nimport { type Ref, ref, watch } from \"vue\";\nimport { useI18n } from \"vue-i18n\";\nimport { useToast } from \"vue-toastification\";\nimport type { VDataTable } from \"vuetify/components\";\n\nimport * as api from \"@/api\";\nimport type { LogEntry } from \"@/api\";\nimport DiffViewer from \"@/components/auditlog/DiffViewer.vue\";\nimport DateTimeCell from \"@/components/table/DateTimeCell.vue\";\nimport { type LoadOptions, useAuditLogUtils } from \"@/composables/useAuditLogUtils\";\n\ntype ReadonlyHeaders = VDataTable[\"$props\"][\"headers\"];\n\nconst props = defineProps<{\n    appLabel: string;\n    model: string;\n    objectPk?: string | number;\n}>();\n\nconst dialogVisible = defineModel<boolean>({ default: false });\n\nconst { t } = useI18n();\nconst toast = useToast();\nconst { actionLabel, actionColor } = useAuditLogUtils();\n\nconst loading = ref(false);\nconst defaultPageSize = 10;\nconst pageSizeOptions = [defaultPageSize, 25, 50];\nconst perPage = ref(defaultPageSize);\nconst totalItems = ref(0);\nconst currentPage = ref(1);\nconst entries: Ref<LogEntry[]> = ref([]);\nconst expanded: Ref<string[]> = ref([]);\n\nconst headers: ReadonlyHeaders = [\n    { title: \"\", key: \"data-table-expand\", width: 50 },\n    { title: t(\"AuditLogTable.headers.timestamp\"), key: \"timestamp\", sortable: true },\n    { title: t(\"AuditLogTable.headers.user\"), key: \"actor\", sortable: false },\n    { title: t(\"AuditLogTable.headers.action\"), key: \"action\", sortable: false, width: 100 },\n    { title: t(\"AuditLogTable.headers.object\"), key: \"object_repr\", sortable: false },\n];\n\nasync function loadData(options: LoadOptions) {\n    loading.value = true;\n    try {\n        const query: api.AdminAuditlogListData[\"query\"] = {\n            app_label: props.appLabel,\n            model: props.model,\n            limit: options.itemsPerPage,\n            offset: (options.page - 1) * options.itemsPerPage,\n        };\n\n        if (props.objectPk !== undefined) {\n            query.object_pk = String(props.objectPk);\n        }\n\n        if (options.sortBy.length > 0) {\n            const sort = options.sortBy[0];\n            if (sort) {\n                query.ordering = sort.order === \"desc\" ? `-${sort.key}` : sort.key;\n            }\n        }\n\n        const response = await api.adminAuditlogList({ query });\n        entries.value = response.data?.results ?? [];\n        totalItems.value = response.data?.count ?? 0;\n    } catch (e) {\n        toast.error(t(\"AuditLogTable.loadFailure\"));\n        console.error(e);\n    } finally {\n        loading.value = false;\n    }\n}\n\n// Load data when dialog opens\nwatch(dialogVisible, (visible) => {\n    if (visible) {\n        currentPage.value = 1;\n        loadData({\n            page: 1,\n            itemsPerPage: perPage.value ?? defaultPageSize,\n            sortBy: [{ key: \"timestamp\", order: \"desc\" }],\n        });\n    }\n});\n</script>\n"],"names":["defaultPageSize","props","__props","dialogVisible","_useModel","t","useI18n","toast","useToast","actionLabel","actionColor","useAuditLogUtils","loading","ref","pageSizeOptions","perPage","totalItems","currentPage","entries","expanded","headers","loadData","options","query","sort","response","api.adminAuditlogList","e","watch","visible","_createBlock","_component_v_dialog","$event","_createVNode","_component_v_card","_component_v_card_title","_unref","FontAwesomeIcon","faClockRotateLeft","_toDisplayString","_component_v_spacer","_component_v_btn","faXmark","_component_v_divider","_component_v_card_text","_component_v_data_table_server","_withCtx","item","DateTimeCell","_createTextVNode","_component_v_chip","_createElementVNode","_hoisted_1","columns","DiffViewer"],"mappings":"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"}