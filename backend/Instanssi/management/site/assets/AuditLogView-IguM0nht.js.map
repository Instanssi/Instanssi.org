{"version":3,"file":"AuditLogView-IguM0nht.js","sources":["../../../../../admin/src/views/auditlog/AuditLogView.vue"],"sourcesContent":["<template>\n    <LayoutBase :breadcrumbs=\"breadcrumbs\">\n        <v-col>\n            <v-row class=\"align-center\">\n                <v-select\n                    v-model=\"selectedModel\"\n                    variant=\"outlined\"\n                    density=\"compact\"\n                    :label=\"t('AuditLogView.filterByModel')\"\n                    :items=\"modelOptions\"\n                    item-title=\"label\"\n                    item-value=\"value\"\n                    style=\"max-width: 300px\"\n                    class=\"ma-0 pa-0\"\n                    clearable\n                    @update:model-value=\"onFilterChange\"\n                />\n            </v-row>\n        </v-col>\n        <v-col>\n            <v-row>\n                <v-data-table-server\n                    v-model:items-per-page=\"perPage\"\n                    v-model:expanded=\"expanded\"\n                    class=\"elevation-1 primary\"\n                    item-value=\"id\"\n                    density=\"compact\"\n                    :headers=\"headers\"\n                    :items=\"entries\"\n                    :items-length=\"totalItems\"\n                    :loading=\"loading\"\n                    :page=\"currentPage\"\n                    :items-per-page-options=\"pageSizeOptions\"\n                    :no-data-text=\"t('AuditLogView.noEntriesFound')\"\n                    :loading-text=\"t('AuditLogView.loadingEntries')\"\n                    show-expand\n                    @update:options=\"debouncedLoad\"\n                >\n                    <template #item.timestamp=\"{ item }\">\n                        <DateTimeCell :value=\"item.timestamp\" />\n                    </template>\n                    <template #item.actor=\"{ item }\">\n                        {{ item.actor?.username ?? t(\"AuditLogView.system\") }}\n                    </template>\n                    <template #item.action=\"{ item }\">\n                        <v-chip :color=\"actionColor(item.action)\" size=\"small\" variant=\"tonal\">\n                            {{ actionLabel(item.action) }}\n                        </v-chip>\n                    </template>\n                    <template #item.content_type=\"{ item }\">\n                        {{ item.content_type?.app_label }}.{{ item.content_type?.model }}\n                    </template>\n                    <template #item.object_repr=\"{ item }\">\n                        <span class=\"text-truncate\" style=\"max-width: 300px; display: inline-block\">\n                            {{ item.object_repr }}\n                        </span>\n                    </template>\n                    <template #expanded-row=\"{ columns, item }\">\n                        <tr>\n                            <td :colspan=\"columns.length\" class=\"pa-4 bg-grey-lighten-4\">\n                                <DiffViewer :changes=\"item.changes\" />\n                            </td>\n                        </tr>\n                    </template>\n                </v-data-table-server>\n            </v-row>\n        </v-col>\n    </LayoutBase>\n</template>\n\n<script setup lang=\"ts\">\nimport { debounce } from \"lodash-es\";\nimport { type Ref, ref } from \"vue\";\nimport { useI18n } from \"vue-i18n\";\nimport { useToast } from \"vue-toastification\";\nimport type { VDataTable } from \"vuetify/components\";\n\nimport * as api from \"@/api\";\nimport type { LogEntry } from \"@/api\";\nimport DiffViewer from \"@/components/auditlog/DiffViewer.vue\";\nimport LayoutBase, { type BreadcrumbItem } from \"@/components/layout/LayoutBase.vue\";\nimport DateTimeCell from \"@/components/table/DateTimeCell.vue\";\nimport { type LoadOptions, useAuditLogUtils } from \"@/composables/useAuditLogUtils\";\n\ntype ReadonlyHeaders = VDataTable[\"$props\"][\"headers\"];\n\ninterface ModelOption {\n    label: string;\n    value: string; // format: \"app_label.model\"\n}\n\nconst { t } = useI18n();\nconst toast = useToast();\nconst { actionLabel: getActionLabel, actionColor } = useAuditLogUtils();\n\nconst breadcrumbs: BreadcrumbItem[] = [{ title: t(\"AuditLogView.title\"), disabled: true }];\n\n// Wrapper to use AuditLogView translations\nfunction actionLabel(action: number): string {\n    return getActionLabel(action, \"AuditLogView\");\n}\n\n// Available models for filtering\nconst modelOptions: ModelOption[] = [\n    { label: t(\"AuditLogView.models.user\"), value: \"users.user\" },\n    { label: t(\"AuditLogView.models.event\"), value: \"kompomaatti.event\" },\n    { label: t(\"AuditLogView.models.blogEntry\"), value: \"ext_blog.blogentry\" },\n    { label: t(\"AuditLogView.models.programmeEvent\"), value: \"ext_programme.programmeevent\" },\n    { label: t(\"AuditLogView.models.compo\"), value: \"kompomaatti.compo\" },\n    { label: t(\"AuditLogView.models.entry\"), value: \"kompomaatti.entry\" },\n    { label: t(\"AuditLogView.models.competition\"), value: \"kompomaatti.competition\" },\n    {\n        label: t(\"AuditLogView.models.competitionParticipation\"),\n        value: \"kompomaatti.competitionparticipation\",\n    },\n    { label: t(\"AuditLogView.models.storeItem\"), value: \"store.storeitem\" },\n    { label: t(\"AuditLogView.models.storeTransaction\"), value: \"store.storetransaction\" },\n    { label: t(\"AuditLogView.models.uploadedFile\"), value: \"admin_upload.uploadedfile\" },\n    { label: t(\"AuditLogView.models.otherVideo\"), value: \"arkisto.othervideo\" },\n    { label: t(\"AuditLogView.models.otherVideoCategory\"), value: \"arkisto.othervideocategory\" },\n];\n\nconst loading = ref(false);\nconst defaultPageSize = 25;\nconst pageSizeOptions = [defaultPageSize, 50, 100];\nconst perPage = ref(defaultPageSize);\nconst totalItems = ref(0);\nconst currentPage = ref(1);\nconst entries: Ref<LogEntry[]> = ref([]);\nconst expanded: Ref<string[]> = ref([]);\nconst selectedModel = ref<string | null>(null);\nconst lastLoadOptions: Ref<LoadOptions | null> = ref(null);\n\nconst headers: ReadonlyHeaders = [\n    { title: \"\", key: \"data-table-expand\", width: 50 },\n    {\n        title: t(\"AuditLogView.headers.timestamp\"),\n        key: \"timestamp\",\n        sortable: true,\n    },\n    {\n        title: t(\"AuditLogView.headers.user\"),\n        key: \"actor\",\n        sortable: false,\n    },\n    {\n        title: t(\"AuditLogView.headers.action\"),\n        key: \"action\",\n        sortable: false,\n        width: 100,\n    },\n    {\n        title: t(\"AuditLogView.headers.model\"),\n        key: \"content_type\",\n        sortable: false,\n    },\n    {\n        title: t(\"AuditLogView.headers.object\"),\n        key: \"object_repr\",\n        sortable: false,\n    },\n];\n\nfunction onFilterChange() {\n    // Reset to page 1 when filter changes\n    currentPage.value = 1;\n    if (lastLoadOptions.value) {\n        load({ ...lastLoadOptions.value, page: 1 });\n    }\n}\n\nasync function load(options: LoadOptions) {\n    loading.value = true;\n    lastLoadOptions.value = options;\n    try {\n        const query: api.AdminAuditlogListData[\"query\"] = {\n            limit: options.itemsPerPage,\n            offset: (options.page - 1) * options.itemsPerPage,\n        };\n\n        // Add model filter if selected\n        if (selectedModel.value) {\n            const [appLabel, model] = selectedModel.value.split(\".\");\n            query.app_label = appLabel;\n            query.model = model;\n        }\n\n        if (options.sortBy.length > 0) {\n            const sort = options.sortBy[0];\n            if (sort) {\n                query.ordering = sort.order === \"desc\" ? `-${sort.key}` : sort.key;\n            }\n        }\n\n        const response = await api.adminAuditlogList({ query });\n        entries.value = response.data?.results ?? [];\n        totalItems.value = response.data?.count ?? 0;\n    } catch (e) {\n        toast.error(t(\"AuditLogView.loadFailure\"));\n        console.error(e);\n    } finally {\n        loading.value = false;\n    }\n}\n\nconst debouncedLoad = debounce(load, 250);\n</script>\n"],"names":["defaultPageSize","t","useI18n","toast","useToast","getActionLabel","actionColor","useAuditLogUtils","breadcrumbs","actionLabel","action","modelOptions","loading","ref","pageSizeOptions","perPage","totalItems","currentPage","entries","expanded","selectedModel","lastLoadOptions","headers","onFilterChange","load","options","query","appLabel","model","sort","response","api.adminAuditlogList","e","debouncedLoad","debounce","_createBlock","LayoutBase","_createVNode","_component_v_col","_component_v_row","_component_v_select","$event","_unref","_component_v_data_table_server","_withCtx","item","DateTimeCell","_createTextVNode","_toDisplayString","_component_v_chip","_createElementVNode","_hoisted_1","columns","DiffViewer"],"mappings":"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"}