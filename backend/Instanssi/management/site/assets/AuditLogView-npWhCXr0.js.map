{"version":3,"file":"AuditLogView-npWhCXr0.js","sources":["../../../../../admin/src/views/auditlog/AuditLogView.vue"],"sourcesContent":["<template>\n    <LayoutBase :breadcrumbs=\"breadcrumbs\">\n        <v-col>\n            <v-row class=\"align-center\">\n                <v-select\n                    v-model=\"selectedModel\"\n                    variant=\"outlined\"\n                    density=\"compact\"\n                    :label=\"t('AuditLogView.filterByModel')\"\n                    :items=\"modelOptions\"\n                    item-title=\"label\"\n                    item-value=\"value\"\n                    style=\"max-width: 300px\"\n                    class=\"ma-0 pa-0\"\n                    clearable\n                    @update:model-value=\"onFilterChange\"\n                />\n            </v-row>\n        </v-col>\n        <v-col>\n            <v-row>\n                <v-data-table-server\n                    v-model:items-per-page=\"tableState.perPage.value\"\n                    v-model:expanded=\"expanded\"\n                    :sort-by=\"tableState.sortByArray.value\"\n                    class=\"elevation-1 primary\"\n                    item-value=\"id\"\n                    density=\"compact\"\n                    :headers=\"headers\"\n                    :items=\"entries\"\n                    :items-length=\"totalItems\"\n                    :loading=\"loading\"\n                    :page=\"tableState.page.value\"\n                    :items-per-page-options=\"tableState.pageSizeOptions\"\n                    :no-data-text=\"t('AuditLogView.noEntriesFound')\"\n                    :loading-text=\"t('AuditLogView.loadingEntries')\"\n                    show-expand\n                    @update:options=\"onTableOptionsUpdate\"\n                >\n                    <template #item.timestamp=\"{ item }\">\n                        <DateTimeCell :value=\"item.timestamp\" />\n                    </template>\n                    <template #item.actor=\"{ item }\">\n                        {{ item.actor?.username ?? t(\"AuditLogView.system\") }}\n                    </template>\n                    <template #item.action=\"{ item }\">\n                        <v-chip :color=\"actionColor(item.action)\" size=\"small\" variant=\"tonal\">\n                            {{ actionLabel(item.action) }}\n                        </v-chip>\n                    </template>\n                    <template #item.content_type=\"{ item }\">\n                        {{ item.content_type?.app_label }}.{{ item.content_type?.model }}\n                    </template>\n                    <template #item.object_repr=\"{ item }\">\n                        <span class=\"text-truncate\" style=\"max-width: 300px; display: inline-block\">\n                            {{ item.object_repr }}\n                        </span>\n                    </template>\n                    <template #expanded-row=\"{ columns, item }\">\n                        <tr>\n                            <td :colspan=\"columns.length\" class=\"pa-4 bg-grey-lighten-4\">\n                                <DiffViewer :changes=\"item.changes\" />\n                            </td>\n                        </tr>\n                    </template>\n                </v-data-table-server>\n            </v-row>\n        </v-col>\n    </LayoutBase>\n</template>\n\n<script setup lang=\"ts\">\nimport { debounce } from \"lodash-es\";\nimport { type Ref, computed, ref } from \"vue\";\nimport { useI18n } from \"vue-i18n\";\nimport { useToast } from \"vue-toastification\";\nimport type { VDataTable } from \"vuetify/components\";\n\nimport * as api from \"@/api\";\nimport type { LogEntry } from \"@/api\";\nimport DiffViewer from \"@/components/auditlog/DiffViewer.vue\";\nimport LayoutBase, { type BreadcrumbItem } from \"@/components/layout/LayoutBase.vue\";\nimport DateTimeCell from \"@/components/table/DateTimeCell.vue\";\nimport { type LoadOptions, useAuditLogUtils } from \"@/composables/useAuditLogUtils\";\nimport { useTableState } from \"@/composables/useTableState\";\n\ntype ReadonlyHeaders = VDataTable[\"$props\"][\"headers\"];\n\ninterface ModelOption {\n    label: string;\n    value: string; // format: \"app_label.model\"\n}\n\nconst { t } = useI18n();\nconst toast = useToast();\nconst { actionLabel: getActionLabel, actionColor } = useAuditLogUtils();\n\nconst breadcrumbs: BreadcrumbItem[] = [{ title: t(\"AuditLogView.title\"), disabled: true }];\n\n// Wrapper to use AuditLogView translations\nfunction actionLabel(action: number): string {\n    return getActionLabel(action, \"AuditLogView\");\n}\n\n// Available models for filtering\nconst modelOptions: ModelOption[] = [\n    { label: t(\"AuditLogView.models.user\"), value: \"users.user\" },\n    { label: t(\"AuditLogView.models.event\"), value: \"kompomaatti.event\" },\n    { label: t(\"AuditLogView.models.blogEntry\"), value: \"ext_blog.blogentry\" },\n    { label: t(\"AuditLogView.models.programmeEvent\"), value: \"ext_programme.programmeevent\" },\n    { label: t(\"AuditLogView.models.compo\"), value: \"kompomaatti.compo\" },\n    { label: t(\"AuditLogView.models.entry\"), value: \"kompomaatti.entry\" },\n    { label: t(\"AuditLogView.models.competition\"), value: \"kompomaatti.competition\" },\n    {\n        label: t(\"AuditLogView.models.competitionParticipation\"),\n        value: \"kompomaatti.competitionparticipation\",\n    },\n    { label: t(\"AuditLogView.models.storeItem\"), value: \"store.storeitem\" },\n    { label: t(\"AuditLogView.models.storeTransaction\"), value: \"store.storetransaction\" },\n    { label: t(\"AuditLogView.models.uploadedFile\"), value: \"admin_upload.uploadedfile\" },\n    { label: t(\"AuditLogView.models.otherVideo\"), value: \"arkisto.othervideo\" },\n    { label: t(\"AuditLogView.models.otherVideoCategory\"), value: \"arkisto.othervideocategory\" },\n];\n\nconst loading = ref(false);\nconst tableState = useTableState({ filterKeys: [\"model\"] });\nconst totalItems = ref(0);\nconst entries: Ref<LogEntry[]> = ref([]);\nconst expanded: Ref<string[]> = ref([]);\nconst lastLoadOptions: Ref<LoadOptions | null> = ref(null);\n\nconst selectedModel = computed({\n    get: () => {\n        const value = tableState.filters.value.model;\n        return value ?? null;\n    },\n    set: (value: string | null) => {\n        tableState.setFilter(\"model\", value);\n    },\n});\n\nconst headers: ReadonlyHeaders = [\n    { title: \"\", key: \"data-table-expand\", width: 50 },\n    {\n        title: t(\"AuditLogView.headers.timestamp\"),\n        key: \"timestamp\",\n        sortable: true,\n    },\n    {\n        title: t(\"AuditLogView.headers.user\"),\n        key: \"actor\",\n        sortable: false,\n    },\n    {\n        title: t(\"AuditLogView.headers.action\"),\n        key: \"action\",\n        sortable: false,\n        width: 100,\n    },\n    {\n        title: t(\"AuditLogView.headers.model\"),\n        key: \"content_type\",\n        sortable: false,\n    },\n    {\n        title: t(\"AuditLogView.headers.object\"),\n        key: \"object_repr\",\n        sortable: false,\n    },\n];\n\nfunction onFilterChange() {\n    // Reset to page 1 when filter changes\n    tableState.page.value = 1;\n    if (lastLoadOptions.value) {\n        load({ ...lastLoadOptions.value, page: 1 });\n    }\n}\n\nfunction onTableOptionsUpdate(options: LoadOptions) {\n    // Adapt LoadOptions to LoadArgs for tableState\n    tableState.onOptionsUpdate({\n        ...options,\n        groupBy: [] as never,\n        search: \"\",\n    });\n    debouncedLoad(options);\n}\n\nasync function load(options: LoadOptions) {\n    loading.value = true;\n    lastLoadOptions.value = options;\n    try {\n        const query: api.AdminAuditlogListData[\"query\"] = {\n            limit: options.itemsPerPage,\n            offset: (options.page - 1) * options.itemsPerPage,\n        };\n\n        // Add model filter if selected\n        if (selectedModel.value) {\n            const [appLabel, model] = selectedModel.value.split(\".\");\n            query.app_label = appLabel;\n            query.model = model;\n        }\n\n        if (options.sortBy.length > 0) {\n            const sort = options.sortBy[0];\n            if (sort) {\n                query.ordering = sort.order === \"desc\" ? `-${sort.key}` : sort.key;\n            }\n        }\n\n        const response = await api.adminAuditlogList({ query });\n        entries.value = response.data?.results ?? [];\n        totalItems.value = response.data?.count ?? 0;\n    } catch (e) {\n        toast.error(t(\"AuditLogView.loadFailure\"));\n        console.error(e);\n    } finally {\n        loading.value = false;\n    }\n}\n\nconst debouncedLoad = debounce(load, 250);\n</script>\n"],"names":["t","useI18n","toast","useToast","getActionLabel","actionColor","useAuditLogUtils","breadcrumbs","actionLabel","action","modelOptions","loading","ref","tableState","useTableState","totalItems","entries","expanded","lastLoadOptions","selectedModel","computed","value","headers","onFilterChange","load","onTableOptionsUpdate","options","debouncedLoad","query","appLabel","model","sort","response","api.adminAuditlogList","e","debounce","_createBlock","LayoutBase","_createVNode","_component_v_col","_component_v_row","_component_v_select","$event","_unref","_component_v_data_table_server","_withCtx","item","DateTimeCell","_createTextVNode","_toDisplayString","_component_v_chip","_createElementVNode","_hoisted_1","columns","DiffViewer"],"mappings":"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"}