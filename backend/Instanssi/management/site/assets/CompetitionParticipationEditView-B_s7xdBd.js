import{d as se,a as le,u as re,v as ne,bt as ue,bu as de,o as me,bv as pe,b as v,g as f,w as s,e as t,A as ce,p as ve,B as fe,l as be,j as a,a3 as Ve,m as F,i as V,t as C,D as j,C as Ce,E as _e,V as D,k as we,G as ye,s as u,I as b,aP as ge,T as qe,H as Pe}from"./index-DXU74lGt.js";import{c as Ee,a as T,d as ke,g as M,u as Ie,b as d}from"./index.esm-DWTrtXO7.js";import{_ as Fe}from"./AuditLogButton.vue_vue_type_script_setup_true_lang-5kFykphF.js";import{V as Me,_ as Ne}from"./DisqualificationField.vue_vue_type_script_setup_true_lang-Dxhy7agJ.js";import{F as G}from"./FormSection-ByskKXOp.js";import{V as m,_ as Re}from"./LayoutBase.vue_vue_type_script_setup_true_lang-D4jd1chv.js";import{h as K}from"./http-BTZWMaMN.js";import{p as N}from"./parseInt-Bzw_2rWL.js";import{V as Se}from"./VForm-C430u1Uz.js";import{V as O}from"./VRow-B94Tto0H.js";import"./AuditLogDialog.vue_vue_type_script_setup_true_lang-WkXOSlqa.js";import"./useAuditLogUtils-BqNOieoY.js";import"./DateTimeCell.vue_vue_type_script_setup_true_lang-BMnBYvTq.js";import"./datetime-Dz9fjSvq.js";import"./VDataTableServer-CMLVDy59.js";import"./VDataTable-Jd7io3gq.js";import"./VSwitch-DB1fJMny.js";import"./VContainer-BfWqa_tJ.js";const Xe=se({__name:"CompetitionParticipationEditView",props:{eventId:{},id:{}},setup(L){const R={competition:"competition",user:"user",participant_name:"participantName",score:"score",disqualified:"disqualified",disqualified_reason:"disqualifiedReason"},r=L,{t:o}=le(),z=re(),p=ne(),{getEventById:H}=Pe(),_=u(!1),w=u(!1),S=u(""),c=b(()=>N(r.eventId,10)),n=b(()=>r.id!==void 0),x=u([]),U=u([]),h=u("-"),J=b(()=>{const e=[{title:H(c.value)?.name??"...",to:{name:"dashboard",params:{eventId:r.eventId}}},{title:o("CompetitionParticipationsView.title"),to:{name:"competition-participations",params:{eventId:r.eventId}}}];return n.value?e.push({title:S.value||"...",disabled:!0}):e.push({title:o("Breadcrumbs.newParticipation"),disabled:!0}),e}),Q=b(()=>x.value.map(e=>({title:e.name,value:e.id}))),W=b(()=>U.value.map(e=>({title:e.username,value:e.id}))),X=Ee({competition:M().required(),user:M().required(),participantName:T().max(64),score:M().nullable(),disqualified:ke(),disqualifiedReason:T()}),{handleSubmit:Y,setValues:Z,setErrors:B,meta:ee}=Ie({validationSchema:X,initialValues:{competition:null,user:null,participantName:"",score:null,disqualified:!1,disqualifiedReason:""}}),y=d("competition"),g=d("user"),q=d("participantName"),P=d("score"),E=d("disqualified"),k=d("disqualifiedReason"),$=Y(async e=>{w.value=!0;let i;n.value?i=await ie(N(r.id,10),e):i=await ae(e),w.value=!1,i&&I()});function A(e,i){return{competition:i?e.competition:void 0,user:i?e.user:void 0,participant_name:e.participantName||"",score:e.score,disqualified:e.disqualified,disqualified_reason:e.disqualifiedReason||""}}async function ae(e){try{return await ue({path:{event_pk:c.value},body:A(e,!0)}),p.success(o("CompetitionParticipationEditView.createSuccess")),!0}catch(i){K(i,B,p,o("CompetitionParticipationEditView.createFailure"),R)}return!1}async function ie(e,i){try{return await de({path:{event_pk:c.value,id:e},body:A(i,!1)}),p.success(o("CompetitionParticipationEditView.editSuccess")),!0}catch(l){K(l,B,p,o("CompetitionParticipationEditView.editFailure"),R)}return!1}function I(){z.push({name:"competition-participations",params:{eventId:r.eventId}})}async function te(){try{const e=await ge({path:{event_pk:c.value},query:{limit:100}});x.value=e.data.results}catch(e){console.error("Failed to load competitions:",e)}}async function oe(){try{const e=await qe({query:{limit:1e3}});U.value=e.data.results}catch(e){console.error("Failed to load users:",e)}}return me(async()=>{if(await Promise.all([te(),oe()]),n.value){_.value=!0;try{const i=(await pe({path:{event_pk:c.value,id:N(r.id,10)}})).data;S.value=i.participant_name||`#${i.id}`,h.value=i.rank?.toString()??"-",Z({competition:i.competition,user:i.user,participantName:i.participant_name??"",score:i.score??null,disqualified:i.disqualified??!1,disqualifiedReason:i.disqualified_reason??""})}catch(e){p.error(o("CompetitionParticipationEditView.loadFailure")),console.error(e),I()}finally{_.value=!1}}}),(e,i)=>(v(),f(Re,{breadcrumbs:J.value},{default:s(()=>[_.value?(v(),f(m,{key:0,class:"d-flex justify-center my-8"},{default:s(()=>[t(ce,{indeterminate:"",size:"64"})]),_:1})):(v(),f(m,{key:1},{default:s(()=>[t(ve,null,{default:s(()=>[t(fe,null,{default:s(()=>[t(Se,{onSubmit:be(a($),["prevent"])},{default:s(()=>[t(O,null,{default:s(()=>[t(m,{cols:"12",md:"6"},{default:s(()=>[t(Ve,{modelValue:a(y).value.value,"onUpdate:modelValue":i[0]||(i[0]=l=>a(y).value.value=l),modelModifiers:{number:!0},items:Q.value,"error-messages":a(y).errorMessage.value,variant:"outlined",label:a(o)("CompetitionParticipationEditView.labels.competition")+" *",disabled:n.value},null,8,["modelValue","items","error-messages","label","disabled"])]),_:1}),t(m,{cols:"12",md:"6"},{default:s(()=>[t(Me,{modelValue:a(g).value.value,"onUpdate:modelValue":i[1]||(i[1]=l=>a(g).value.value=l),modelModifiers:{number:!0},items:W.value,"error-messages":a(g).errorMessage.value,variant:"outlined",label:a(o)("CompetitionParticipationEditView.labels.user")+" *",disabled:n.value},null,8,["modelValue","items","error-messages","label","disabled"])]),_:1})]),_:1}),t(F,{modelValue:a(q).value.value,"onUpdate:modelValue":i[2]||(i[2]=l=>a(q).value.value=l),"error-messages":a(q).errorMessage.value,variant:"outlined",label:a(o)("CompetitionParticipationEditView.labels.participantName")},null,8,["modelValue","error-messages","label"]),t(G,null,{default:s(()=>[V(C(a(o)("CompetitionParticipationEditView.sections.scoring")),1)]),_:1}),t(O,null,{default:s(()=>[t(m,{cols:"12",md:"6"},{default:s(()=>[t(F,{modelValue:a(P).value.value,"onUpdate:modelValue":i[3]||(i[3]=l=>a(P).value.value=l),modelModifiers:{number:!0},type:"number","error-messages":a(P).errorMessage.value,variant:"outlined",label:a(o)("CompetitionParticipationEditView.labels.score")},null,8,["modelValue","error-messages","label"])]),_:1}),n.value?(v(),f(m,{key:0,cols:"12",md:"6"},{default:s(()=>[t(F,{"model-value":h.value,variant:"outlined",label:a(o)("CompetitionParticipationEditView.labels.rank"),readonly:""},null,8,["model-value","label"])]),_:1})):j("",!0)]),_:1}),t(G,null,{default:s(()=>[V(C(a(o)("CompetitionParticipationEditView.sections.disqualification")),1)]),_:1}),t(Ne,{modelValue:a(E).value.value,"onUpdate:modelValue":i[4]||(i[4]=l=>a(E).value.value=l),reason:a(k).value.value,"onUpdate:reason":i[5]||(i[5]=l=>a(k).value.value=l),"error-message":a(E).errorMessage.value,"reason-error-message":a(k).errorMessage.value,"label-on":a(o)("CompetitionParticipationEditView.labels.disqualifiedOn"),"label-off":a(o)("CompetitionParticipationEditView.labels.disqualifiedOff"),"reason-label":a(o)("CompetitionParticipationEditView.labels.disqualifiedReason")},null,8,["modelValue","reason","error-message","reason-error-message","label-on","label-off","reason-label"])]),_:1},8,["onSubmit"])]),_:1}),t(Ce,{class:"justify-end"},{default:s(()=>[n.value?(v(),f(Fe,{key:0,"app-label":"kompomaatti",model:"competitionparticipation","object-pk":r.id},null,8,["object-pk"])):j("",!0),t(_e),t(D,{variant:"text",onClick:I},{default:s(()=>[V(C(a(o)("General.cancel")),1)]),_:1}),t(D,{variant:"elevated",color:"primary",loading:w.value,disabled:!a(ee).valid,onClick:a($)},{prepend:s(()=>[t(a(we),{icon:a(ye)},null,8,["icon"])]),default:s(()=>[V(" "+C(a(o)("General.save")),1)]),_:1},8,["loading","disabled","onClick"])]),_:1})]),_:1})]),_:1}))]),_:1},8,["breadcrumbs"]))}});export{Xe as default};
//# sourceMappingURL=CompetitionParticipationEditView-B_s7xdBd.js.map
