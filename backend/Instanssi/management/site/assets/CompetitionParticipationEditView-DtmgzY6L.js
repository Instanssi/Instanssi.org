import{d as se,a as le,u as re,v as ne,bB as ue,bC as de,o as me,bD as pe,b as v,g as f,w as s,e as t,A as ce,p as ve,B as fe,l as be,j as a,N as Ve,m as F,i as V,t as C,D,C as Ce,E as _e,V as j,k as we,G as ye,s as u,I as b,aR as ge,X as qe,H as Ee}from"./index-CQkWvXOv.js";import{c as Pe,a as G,d as ke,g as N,u as Ie,b as d}from"./index.esm-aFENq7CA.js";import{_ as Fe}from"./AuditLogButton.vue_vue_type_script_setup_true_lang-DHg2h5we.js";import{V as Ne,_ as Me}from"./DisqualificationField.vue_vue_type_script_setup_true_lang-B87D3QPJ.js";import{F as K}from"./FormSection-Drw9hFWe.js";import{V as m,_ as Re}from"./LayoutBase.vue_vue_type_script_setup_true_lang-D5aCeQDf.js";import{h as O}from"./http-CET7UDul.js";import{p as M}from"./parseInt-BJ5A4_3y.js";import{V as Se}from"./VForm-VvaADaOh.js";import{V as T}from"./VRow-CXIXhuhq.js";import"./_commonjsHelpers-CqkleIqs.js";import"./AuditLogDialog.vue_vue_type_script_setup_true_lang-1MnYozFL.js";import"./useAuditLogUtils-BdjF9k7b.js";import"./DateTimeCell.vue_vue_type_script_setup_true_lang-DaLynL44.js";import"./datetime-Dz9fjSvq.js";import"./VDataTableServer-C6tuZDKn.js";import"./VDataTable-f5_9vewM.js";import"./VSwitch-JF6EcneO.js";import"./VContainer-DqJ8gu3P.js";const Ye=se({__name:"CompetitionParticipationEditView",props:{eventId:{},id:{}},setup(L){const R={competition:"competition",user:"user",participant_name:"participantName",score:"score",disqualified:"disqualified",disqualified_reason:"disqualifiedReason"},r=L,{t:o}=le(),z=re(),p=ne(),{getEventById:H}=Ee(),_=u(!1),w=u(!1),S=u(""),c=b(()=>M(r.eventId,10)),n=b(()=>r.id!==void 0),x=u([]),B=u([]),U=u("-"),X=b(()=>{const e=[{title:H(c.value)?.name??"...",to:{name:"dashboard",params:{eventId:r.eventId}}},{title:o("CompetitionParticipationsView.title"),to:{name:"competition-participations",params:{eventId:r.eventId}}}];return n.value?e.push({title:S.value||"...",disabled:!0}):e.push({title:o("Breadcrumbs.newParticipation"),disabled:!0}),e}),J=b(()=>x.value.map(e=>({title:e.name,value:e.id}))),Q=b(()=>B.value.map(e=>({title:e.username,value:e.id}))),W=Pe({competition:N().required(),user:N().required(),participantName:G().max(64),score:N().nullable(),disqualified:ke(),disqualifiedReason:G()}),{handleSubmit:Y,setValues:Z,setErrors:h,meta:ee}=Ie({validationSchema:W,initialValues:{competition:null,user:null,participantName:"",score:null,disqualified:!1,disqualifiedReason:""}}),y=d("competition"),g=d("user"),q=d("participantName"),E=d("score"),P=d("disqualified"),k=d("disqualifiedReason"),$=Y(async e=>{w.value=!0;let i;n.value?i=await ie(M(r.id,10),e):i=await ae(e),w.value=!1,i&&I()});function A(e,i){return{competition:i?e.competition:void 0,user:i?e.user:void 0,participant_name:e.participantName||"",score:e.score,disqualified:e.disqualified,disqualified_reason:e.disqualifiedReason||""}}async function ae(e){try{return await ue({path:{event_pk:c.value},body:A(e,!0)}),p.success(o("CompetitionParticipationEditView.createSuccess")),!0}catch(i){O(i,h,p,o("CompetitionParticipationEditView.createFailure"),R)}return!1}async function ie(e,i){try{return await de({path:{event_pk:c.value,id:e},body:A(i,!1)}),p.success(o("CompetitionParticipationEditView.editSuccess")),!0}catch(l){O(l,h,p,o("CompetitionParticipationEditView.editFailure"),R)}return!1}function I(){z.push({name:"competition-participations",params:{eventId:r.eventId}})}async function te(){try{const e=await ge({path:{event_pk:c.value},query:{limit:100}});x.value=e.data.results}catch(e){console.error("Failed to load competitions:",e)}}async function oe(){try{const e=await qe({query:{limit:1e3}});B.value=e.data.results}catch(e){console.error("Failed to load users:",e)}}return me(async()=>{if(await Promise.all([te(),oe()]),n.value){_.value=!0;try{const i=(await pe({path:{event_pk:c.value,id:M(r.id,10)}})).data;S.value=i.participant_name||`#${i.id}`,U.value=i.rank?.toString()??"-",Z({competition:i.competition,user:i.user,participantName:i.participant_name??"",score:i.score??null,disqualified:i.disqualified??!1,disqualifiedReason:i.disqualified_reason??""})}catch(e){p.error(o("CompetitionParticipationEditView.loadFailure")),console.error(e),I()}finally{_.value=!1}}}),(e,i)=>(v(),f(Re,{breadcrumbs:X.value},{default:s(()=>[_.value?(v(),f(m,{key:0,class:"d-flex justify-center my-8"},{default:s(()=>[t(ce,{indeterminate:"",size:"64"})]),_:1})):(v(),f(m,{key:1},{default:s(()=>[t(ve,null,{default:s(()=>[t(fe,null,{default:s(()=>[t(Se,{onSubmit:be(a($),["prevent"])},{default:s(()=>[t(T,null,{default:s(()=>[t(m,{cols:"12",md:"6"},{default:s(()=>[t(Ve,{modelValue:a(y).value.value,"onUpdate:modelValue":i[0]||(i[0]=l=>a(y).value.value=l),modelModifiers:{number:!0},items:J.value,"error-messages":a(y).errorMessage.value,variant:"outlined",label:a(o)("CompetitionParticipationEditView.labels.competition")+" *",disabled:n.value},null,8,["modelValue","items","error-messages","label","disabled"])]),_:1}),t(m,{cols:"12",md:"6"},{default:s(()=>[t(Ne,{modelValue:a(g).value.value,"onUpdate:modelValue":i[1]||(i[1]=l=>a(g).value.value=l),modelModifiers:{number:!0},items:Q.value,"error-messages":a(g).errorMessage.value,variant:"outlined",label:a(o)("CompetitionParticipationEditView.labels.user")+" *",disabled:n.value},null,8,["modelValue","items","error-messages","label","disabled"])]),_:1})]),_:1}),t(F,{modelValue:a(q).value.value,"onUpdate:modelValue":i[2]||(i[2]=l=>a(q).value.value=l),"error-messages":a(q).errorMessage.value,variant:"outlined",label:a(o)("CompetitionParticipationEditView.labels.participantName")},null,8,["modelValue","error-messages","label"]),t(K,null,{default:s(()=>[V(C(a(o)("CompetitionParticipationEditView.sections.scoring")),1)]),_:1}),t(T,null,{default:s(()=>[t(m,{cols:"12",md:"6"},{default:s(()=>[t(F,{modelValue:a(E).value.value,"onUpdate:modelValue":i[3]||(i[3]=l=>a(E).value.value=l),modelModifiers:{number:!0},type:"number","error-messages":a(E).errorMessage.value,variant:"outlined",label:a(o)("CompetitionParticipationEditView.labels.score")},null,8,["modelValue","error-messages","label"])]),_:1}),n.value?(v(),f(m,{key:0,cols:"12",md:"6"},{default:s(()=>[t(F,{"model-value":U.value,variant:"outlined",label:a(o)("CompetitionParticipationEditView.labels.rank"),readonly:""},null,8,["model-value","label"])]),_:1})):D("",!0)]),_:1}),t(K,null,{default:s(()=>[V(C(a(o)("CompetitionParticipationEditView.sections.disqualification")),1)]),_:1}),t(Me,{modelValue:a(P).value.value,"onUpdate:modelValue":i[4]||(i[4]=l=>a(P).value.value=l),reason:a(k).value.value,"onUpdate:reason":i[5]||(i[5]=l=>a(k).value.value=l),"error-message":a(P).errorMessage.value,"reason-error-message":a(k).errorMessage.value,"label-on":a(o)("CompetitionParticipationEditView.labels.disqualifiedOn"),"label-off":a(o)("CompetitionParticipationEditView.labels.disqualifiedOff"),"reason-label":a(o)("CompetitionParticipationEditView.labels.disqualifiedReason")},null,8,["modelValue","reason","error-message","reason-error-message","label-on","label-off","reason-label"])]),_:1},8,["onSubmit"])]),_:1}),t(Ce,{class:"justify-end"},{default:s(()=>[n.value?(v(),f(Fe,{key:0,"app-label":"kompomaatti",model:"competitionparticipation","object-pk":r.id},null,8,["object-pk"])):D("",!0),t(_e),t(j,{variant:"text",onClick:I},{default:s(()=>[V(C(a(o)("General.cancel")),1)]),_:1}),t(j,{variant:"elevated",color:"primary",loading:w.value,disabled:!a(ee).valid,onClick:a($)},{prepend:s(()=>[t(a(we),{icon:a(ye)},null,8,["icon"])]),default:s(()=>[V(" "+C(a(o)("General.save")),1)]),_:1},8,["loading","disabled","onClick"])]),_:1})]),_:1})]),_:1}))]),_:1},8,["breadcrumbs"]))}});export{Ye as default};
//# sourceMappingURL=CompetitionParticipationEditView-DtmgzY6L.js.map
