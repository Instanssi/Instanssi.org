import{d as ue,a as me,u as de,J as fe,K as ve,v as Pe,L as U,o as ge,b as f,g as C,w as s,e as l,j as e,P as V,V as $,i as w,t as k,k as b,M as ye,D,c as Ce,ay as Ve,m as we,N as L,O as ke,a0 as he,aE as be,q as Ie,I,s as c,aR as _e,X as Te,bt as xe,bu as M,H as Ne}from"./index-CQkWvXOv.js";import{_ as Oe,d as De}from"./spreadsheet-B6MwOGQk.js";import{V as K,_ as Ae}from"./LayoutBase.vue_vue_type_script_setup_true_lang-D5aCeQDf.js";import{_ as qe}from"./TableActionButtons.vue_vue_type_script_setup_true_lang-DepTf6Bi.js";import{u as Ee,d as Re}from"./useTableState-CutuDm2i.js";import{g as Fe}from"./query_tools-BInV9OzK.js";import{g as Be}from"./http-CET7UDul.js";import{_ as Se,t as Ue}from"./DiplomaGeneratorDialog.vue_vue_type_script_setup_true_lang-CPwzGiJj.js";import{V as G}from"./VRow-CXIXhuhq.js";import{V as $e}from"./VDataTableServer-C6tuZDKn.js";import{p as j}from"./parseInt-BJ5A4_3y.js";import"./VContainer-DqJ8gu3P.js";import"./AuditLogDialog.vue_vue_type_script_setup_true_lang-1MnYozFL.js";import"./useAuditLogUtils-BdjF9k7b.js";import"./DateTimeCell.vue_vue_type_script_setup_true_lang-DaLynL44.js";import"./datetime-Dz9fjSvq.js";import"./_commonjsHelpers-CqkleIqs.js";import"./VAlert-BCBb7cPR.js";import"./VDataTable-f5_9vewM.js";const Le={key:1,class:"ml-4"},rt=ue({__name:"CompetitionParticipationsView",props:{eventId:{}},setup(X){const _=X,{t:i}=me(),A=de(),z=fe(ve),v=Pe(),P=Ie(),{getEventById:H}=Ne(),p=I(()=>j(_.eventId,10)),T=c(!1),x=c(!1),q=c(void 0),J=I(()=>[{title:H(p.value)?.name??"...",to:{name:"dashboard",params:{eventId:_.eventId}}},{title:i("CompetitionParticipationsView.title"),disabled:!0}]),n=Ee({filterKeys:["competition","disqualified"]}),E=c(0),R=c([]),h=c([]),F=c([]),g=c(null),y=I({get:()=>n.getFilterAsNumber("competition"),set:t=>{n.setFilter("competition",t),n.resetPage()}}),d=n.useBooleanFilter("disqualified"),Q=[{title:i("CompetitionParticipationsView.headers.id"),sortable:!0,key:"id"},{title:i("CompetitionParticipationsView.headers.participantName"),sortable:!0,key:"participant_name"},{title:i("CompetitionParticipationsView.headers.user"),sortable:!1,key:"user"},{title:i("CompetitionParticipationsView.headers.competition"),sortable:!1,key:"competition"},{title:i("CompetitionParticipationsView.headers.score"),sortable:!0,key:"score"},{title:i("CompetitionParticipationsView.headers.disqualified"),sortable:!1,key:"disqualified"},{title:i("CompetitionParticipationsView.headers.rank"),sortable:!1,key:"rank"},{title:i("CompetitionParticipationsView.headers.actions"),sortable:!1,key:"actions",align:"end"}],W=I(()=>[{title:i("CompetitionParticipationsView.allCompetitions"),value:null},...h.value.map(t=>({title:t.name,value:t.id}))]);function Y(t){return h.value.find(a=>a.id===t)?.name??`#${t}`}function Z(t){return F.value.find(a=>a.id===t)?.username??`#${t}`}function ee(){g.value&&S(g.value)}async function B(){try{const t=await _e({path:{event_pk:p.value},query:{limit:100}});h.value=t.data.results}catch(t){console.error("Failed to load competitions:",t)}}async function te(){try{const t=await Te({query:{limit:1e3}});F.value=t.data.results}catch(t){console.error("Failed to load users:",t)}}async function S(t){T.value=!0,g.value=t;try{const o=await M({path:{event_pk:j(_.eventId,10)},query:{...Fe(t),...y.value?{competition:y.value}:{},...d.value!==null?{disqualified:d.value}:{}}});R.value=o.data.results,E.value=o.data.count}catch(o){v.error(i("CompetitionParticipationsView.loadFailure")),console.error(o)}finally{T.value=!1}}const N=Re(S,250);function ae(t){n.onOptionsUpdate(t),N(t)}U([y,d],()=>{g.value&&N({...g.value,page:1})});function ie(){n.setFilter("competition",null),n.setFilter("disqualified",null),n.search.value="",n.page.value=1,B(),N({page:1,itemsPerPage:n.perPage.value??25,sortBy:[],groupBy:[],search:""})}U(p,ie);async function oe(t){const o=i("CompetitionParticipationsView.confirmDelete",{name:t.participant_name||`#${t.id}`});await z.value.ifConfirmed(o,async()=>{try{await xe({path:{event_pk:p.value,id:t.id}}),v.success(i("CompetitionParticipationsView.deleteSuccess")),ee()}catch(a){v.error(Be(a,i("CompetitionParticipationsView.deleteFailure"))),console.error(a)}})}function ne(t){A.push({name:"competition-participations-edit",params:{eventId:p.value,id:t}})}function se(){A.push({name:"competition-participations-new",params:{eventId:p.value}})}function le(){q.value?.open()}function re(t){const o=new Map;for(const r of t){const u=o.get(r.competition)??[];u.push(r),o.set(r.competition,u)}const a=[];for(const r of h.value){const ce=[...o.get(r.id)??[]].sort((m,O)=>m.rank===null&&O.rank===null?0:m.rank===null?1:O.rank===null?-1:m.rank-O.rank).slice(0,3);for(const m of ce)m.rank!==null&&a.push({participantName:m.participant_name||"Unknown",rankString:Ue(m.rank),competitionName:r.name})}return a}async function pe(t){x.value=!0;try{const o=await M({path:{event_pk:p.value},query:{limit:1e4}}),r=re(o.data.results).map(u=>[u.participantName,u.rankString,u.competitionName]);De(r,"instanssi_competition_results",t,"Results"),v.success(i("CompetitionParticipationsView.exportSuccess"))}catch(o){v.error(i("CompetitionParticipationsView.exportFailure")),console.error(o)}finally{x.value=!1}}return ge(()=>{B(),te()}),(t,o)=>(f(),C(Ae,{key:`participations-${p.value}`,breadcrumbs:J.value},{default:s(()=>[l(K,null,{default:s(()=>[l(G,null,{default:s(()=>[e(P).canAdd(e(V).COMPETITION_PARTICIPATION)?(f(),C($,{key:0,color:"primary",onClick:se},{prepend:s(()=>[l(e(b),{icon:e(ye)},null,8,["icon"])]),default:s(()=>[w(" "+k(e(i)("CompetitionParticipationsView.newParticipation")),1)]),_:1})):D("",!0),e(P).canView(e(V).COMPETITION_PARTICIPATION)?(f(),Ce("div",Le,[l(Oe,{label:e(i)("CompetitionParticipationsView.exportResults"),loading:x.value,onExport:pe},null,8,["label","loading"])])):D("",!0),e(P).canView(e(V).COMPETITION_PARTICIPATION)?(f(),C($,{key:2,color:"secondary",class:"ml-4",onClick:le},{prepend:s(()=>[l(e(b),{icon:e(Ve)},null,8,["icon"])]),default:s(()=>[w(" "+k(e(i)("DiplomaGenerator.title")),1)]),_:1})):D("",!0),l(we,{modelValue:e(n).search.value,"onUpdate:modelValue":o[0]||(o[0]=a=>e(n).search.value=a),variant:"outlined",density:"compact",label:e(i)("General.search"),style:{"max-width":"400px"},class:"ma-0 pa-0 ml-4",clearable:""},null,8,["modelValue","label"]),l(L,{modelValue:y.value,"onUpdate:modelValue":o[1]||(o[1]=a=>y.value=a),items:W.value,variant:"outlined",density:"compact",label:e(i)("CompetitionParticipationsView.filterByCompetition"),style:{"max-width":"300px"},class:"ma-0 pa-0 ml-4",clearable:""},null,8,["modelValue","items","label"]),l(L,{modelValue:e(d),"onUpdate:modelValue":o[2]||(o[2]=a=>ke(d)?d.value=a:null),items:[{title:e(i)("CompetitionParticipationsView.allStatuses"),value:null},{title:e(i)("General.disqualifiedOn"),value:!0},{title:e(i)("General.disqualifiedOff"),value:!1}],variant:"outlined",density:"compact",label:e(i)("CompetitionParticipationsView.filterByDisqualified"),style:{"max-width":"200px"},class:"ma-0 pa-0 ml-4"},null,8,["modelValue","items","label"])]),_:1})]),_:1}),l(K,null,{default:s(()=>[l(G,null,{default:s(()=>[l($e,{"items-per-page":e(n).perPage.value,"onUpdate:itemsPerPage":o[3]||(o[3]=a=>e(n).perPage.value=a),"sort-by":e(n).sortByArray.value,class:"elevation-1 primary","item-value":"id",density:"compact",headers:Q,items:R.value,"items-length":E.value,loading:T.value,page:e(n).page.value,search:e(n).search.value,"items-per-page-options":e(n).pageSizeOptions,"no-data-text":e(i)("CompetitionParticipationsView.noParticipationsFound"),"loading-text":e(i)("CompetitionParticipationsView.loadingParticipations"),"onUpdate:options":ae},{"item.competition":s(({item:a})=>[w(k(Y(a.competition)),1)]),"item.user":s(({item:a})=>[w(k(Z(a.user)),1)]),"item.disqualified":s(({item:a})=>[a.disqualified?(f(),C(e(b),{key:0,icon:e(he),class:"text-red"},null,8,["icon"])):(f(),C(e(b),{key:1,icon:e(be),class:"text-green"},null,8,["icon"]))]),"item.rank":s(({item:a})=>[w(k(a.rank??"-"),1)]),"item.actions":s(({item:a})=>[l(qe,{"can-edit":e(P).canChange(e(V).COMPETITION_PARTICIPATION),"can-delete":e(P).canDelete(e(V).COMPETITION_PARTICIPATION),"audit-log":{appLabel:"kompomaatti",model:"competitionparticipation",objectPk:a.id},onEdit:r=>ne(a.id),onDelete:r=>oe(a)},null,8,["can-edit","can-delete","audit-log","onEdit","onDelete"])]),_:1},8,["items-per-page","sort-by","items","items-length","loading","page","search","items-per-page-options","no-data-text","loading-text"])]),_:1})]),_:1}),l(Se,{ref_key:"diplomaDialog",ref:q,"event-id":p.value},null,8,["event-id"])]),_:1},8,["breadcrumbs"]))}});export{rt as default};
//# sourceMappingURL=CompetitionParticipationsView-bRIYh39F.js.map
