import{d as oe,a as le,u as re,J as ie,K as ue,v as ce,U as L,o as me,b as x,g as $,w as o,e as l,j as s,P as g,V as de,i as C,t as I,k as pe,L as fe,D as F,c as ve,a3 as ye,m as ge,q as Ee,I as D,s as r,ap as we,ax as Ve,ay as S,H as he}from"./index-DXU74lGt.js";import{_ as ke}from"./BooleanIcon.vue_vue_type_script_setup_true_lang-CqjGGkAi.js";import{_ as _e,d as be}from"./spreadsheet-ad3MpNLb.js";import{I as xe}from"./ImageCell-DJVG8mod.js";import{V as A,_ as Ce}from"./LayoutBase.vue_vue_type_script_setup_true_lang-D4jd1chv.js";import{M as Ie}from"./MediaCell-DW8EQos6.js";import{_ as De}from"./TableActionButtons.vue_vue_type_script_setup_true_lang-CUVfxWfg.js";import{g as Re}from"./query_tools-BInV9OzK.js";import{g as Pe}from"./http-BTZWMaMN.js";import{d as Be}from"./debounce-CQ84CrOG.js";import{V as U}from"./VRow-B94Tto0H.js";import{V as Ne}from"./VDataTableServer-CMLVDy59.js";import{p as K}from"./parseInt-Bzw_2rWL.js";import"./VContainer-BfWqa_tJ.js";import"./AuditLogDialog.vue_vue_type_script_setup_true_lang-WkXOSlqa.js";import"./useAuditLogUtils-BqNOieoY.js";import"./DateTimeCell.vue_vue_type_script_setup_true_lang-BMnBYvTq.js";import"./datetime-Dz9fjSvq.js";import"./VDataTable-Jd7io3gq.js";const Te={key:1,class:"ml-4"},et=oe({__name:"EntriesView",props:{eventId:{}},setup(M){const E=M,{t:a}=le(),R=re(),Y=ie(ue),d=ce(),f=Ee(),{getEventById:j}=he(),i=D(()=>K(E.eventId,10)),w=r(!1),V=r(!1),O=D(()=>[{title:j(i.value)?.name??"...",to:{name:"dashboard",params:{eventId:E.eventId}}},{title:a("EntriesView.title"),disabled:!0}]),P=[25,50,100],h=r(P[0]),B=r(0),z=r(1),N=r([]),v=r([]),y=r(""),m=r(null),p=r(null),G=[{title:a("EntriesView.headers.id"),sortable:!0,key:"id"},{title:a("EntriesView.headers.image"),sortable:!1,key:"imagefile_thumbnail_url",width:60},{title:a("EntriesView.headers.name"),sortable:!0,key:"name"},{title:a("EntriesView.headers.creator"),sortable:!0,key:"creator"},{title:a("EntriesView.headers.entryfile"),sortable:!1,key:"entryfile_url"},{title:a("EntriesView.headers.compo"),sortable:!1,key:"compo"},{title:a("EntriesView.headers.disqualified"),sortable:!1,key:"disqualified"},{title:a("EntriesView.headers.rank"),sortable:!1,key:"rank"},{title:a("EntriesView.headers.actions"),sortable:!1,key:"actions",align:"end"}],H=D(()=>[{title:a("EntriesView.allCompos"),value:null},...v.value.map(t=>({title:t.name,value:t.id}))]);function J(t){return v.value.find(e=>e.id===t)?.name??`#${t}`}function Q(){p.value&&q(p.value)}async function T(){try{const t=await we({path:{event_pk:i.value},query:{limit:100}});v.value=t.data.results}catch(t){console.error("Failed to load compos:",t)}}async function q(t){w.value=!0,p.value=t;try{const n=await S({path:{event_pk:K(E.eventId,10)},query:{...Re(t),...m.value?{compo:m.value}:{}}});N.value=n.data.results,B.value=n.data.count}catch(n){d.error(a("EntriesView.loadFailure")),console.error(n)}finally{w.value=!1}}const k=Be(q,250);L(m,()=>{p.value&&k(p.value)});function W(){m.value=null,y.value="",T(),k({page:1,itemsPerPage:h.value??25,sortBy:[],groupBy:[],search:""})}L(i,W);async function X(t){const n=a("EntriesView.confirmDelete",t);await Y.value.ifConfirmed(n,async()=>{try{await Ve({path:{event_pk:i.value,id:t.id}}),d.success(a("EntriesView.deleteSuccess")),Q()}catch(e){d.error(Pe(e,a("EntriesView.deleteFailure"))),console.error(e)}})}function Z(t){R.push({name:"entries-edit",params:{eventId:i.value,id:t}})}function ee(){R.push({name:"entries-new",params:{eventId:i.value}})}function te(t){return"I".repeat(t)}function ae(t){const n=new Map;for(const u of t){const _=n.get(u.compo)??[];_.push(u),n.set(u.compo,_)}const e=[];for(const u of v.value){const se=[...n.get(u.id)??[]].sort((c,b)=>c.rank===null&&b.rank===null?0:c.rank===null?1:b.rank===null?-1:c.rank-b.rank).slice(0,3);for(const c of se)c.rank!==null&&e.push([c.name,c.creator,te(c.rank),u.name])}return e}async function ne(t){V.value=!0;try{const n=await S({path:{event_pk:i.value},query:{limit:1e4}}),e=ae(n.data.results);be(e,"instanssi_entries",t,"Results"),d.success(a("EntriesView.exportSuccess"))}catch(n){d.error(a("EntriesView.exportFailure")),console.error(n)}finally{V.value=!1}}return me(()=>{T()}),(t,n)=>(x(),$(Ce,{key:`entries-${i.value}`,breadcrumbs:O.value},{default:o(()=>[l(A,null,{default:o(()=>[l(U,null,{default:o(()=>[s(f).canAdd(s(g).ENTRY)?(x(),$(de,{key:0,color:"primary",onClick:ee},{prepend:o(()=>[l(s(pe),{icon:s(fe)},null,8,["icon"])]),default:o(()=>[C(" "+I(s(a)("EntriesView.newEntry")),1)]),_:1})):F("",!0),s(f).canView(s(g).ENTRY)?(x(),ve("div",Te,[l(_e,{label:s(a)("EntriesView.exportResults"),loading:V.value,onExport:ne},null,8,["label","loading"])])):F("",!0),l(ye,{modelValue:m.value,"onUpdate:modelValue":n[0]||(n[0]=e=>m.value=e),items:H.value,variant:"outlined",density:"compact",label:s(a)("EntriesView.filterByCompo"),style:{"max-width":"300px"},class:"ma-0 pa-0 ml-4",clearable:""},null,8,["modelValue","items","label"]),l(ge,{modelValue:y.value,"onUpdate:modelValue":n[1]||(n[1]=e=>y.value=e),variant:"outlined",density:"compact",label:s(a)("General.search"),style:{"max-width":"400px"},class:"ma-0 pa-0 ml-4",clearable:""},null,8,["modelValue","label"])]),_:1})]),_:1}),l(A,null,{default:o(()=>[l(U,null,{default:o(()=>[l(Ne,{"items-per-page":h.value,"onUpdate:itemsPerPage":n[2]||(n[2]=e=>h.value=e),class:"elevation-1 primary","item-value":"id",density:"compact",headers:G,items:N.value,"items-length":B.value,loading:w.value,search:y.value,page:z.value,"items-per-page-options":P,"no-data-text":s(a)("EntriesView.noEntriesFound"),"loading-text":s(a)("EntriesView.loadingEntries"),"onUpdate:options":s(k)},{"item.imagefile_thumbnail_url":o(({item:e})=>[l(xe,{url:e.imagefile_thumbnail_url},null,8,["url"])]),"item.entryfile_url":o(({item:e})=>[l(Ie,{url:e.entryfile_url},null,8,["url"])]),"item.disqualified":o(({item:e})=>[l(ke,{value:e.disqualified,"true-class":"text-red","false-class":"text-green"},null,8,["value"])]),"item.compo":o(({item:e})=>[C(I(J(e.compo)),1)]),"item.rank":o(({item:e})=>[C(I(e.rank??"-"),1)]),"item.actions":o(({item:e})=>[l(De,{"can-edit":s(f).canChange(s(g).ENTRY),"can-delete":s(f).canDelete(s(g).ENTRY),"audit-log":{appLabel:"kompomaatti",model:"entry",objectPk:e.id},onEdit:u=>Z(e.id),onDelete:u=>X(e)},null,8,["can-edit","can-delete","audit-log","onEdit","onDelete"])]),_:1},8,["items-per-page","items","items-length","loading","search","page","no-data-text","loading-text","onUpdate:options"])]),_:1})]),_:1})]),_:1},8,["breadcrumbs"]))}});export{et as default};
//# sourceMappingURL=EntriesView-BNXYzbyK.js.map
