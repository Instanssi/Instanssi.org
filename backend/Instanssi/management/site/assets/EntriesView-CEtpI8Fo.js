import{d as oe,a as le,u as re,H as ie,I as ue,v as ce,Z as $,o as de,b as x,g as F,w as o,e as l,j as s,P as E,V as me,i as C,t as I,k as pe,J as fe,K as S,c as ve,a2 as ye,m as Ee,q as ge,G as D,s as r,af as we,an as Ve,ao as A,E as he}from"./index-qrfwdmHz.js";import{_ as _e}from"./BooleanIcon.vue_vue_type_script_setup_true_lang-BztPFn-1.js";import{_ as ke,d as be}from"./spreadsheet-Bp_RoeaD.js";import{I as xe}from"./ImageCell-C0IQi5no.js";import{V as L,_ as Ce}from"./LayoutBase.vue_vue_type_script_setup_true_lang-Cgp8Musd.js";import{M as Ie}from"./MediaCell-YN1Cty-c.js";import{_ as De}from"./TableActionButtons.vue_vue_type_script_setup_true_lang-B6FHDr2a.js";import{d as Re,V as Be,g as Ne}from"./query_tools-Ch1hnqwl.js";import{g as Pe}from"./http-Cqy_sGiB.js";import{V as K}from"./VRow-EkiCBxID.js";import{p as M}from"./parseInt-CGa1F4cm.js";import"./VContainer-e74dHNZG.js";import"./VDataTable-BIkGv4dg.js";import"./filter-50Rnsb7m.js";const Te={key:1,class:"ml-4"},Je=oe({__name:"EntriesView",props:{eventId:{}},setup(U){const g=U,{t:a}=le(),R=re(),Y=ie(ue),m=ce(),f=ge(),{getEventById:j}=he(),i=D(()=>M(g.eventId,10)),w=r(!1),V=r(!1),G=D(()=>[{title:j(i.value)?.name??"...",to:{name:"dashboard",params:{eventId:g.eventId}}},{title:a("EntriesView.title"),disabled:!0}]),B=[25,50,100],h=r(B[0]),N=r(0),O=r(1),P=r([]),v=r([]),y=r(""),d=r(null),p=r(null),z=[{title:a("EntriesView.headers.id"),sortable:!0,key:"id"},{title:a("EntriesView.headers.image"),sortable:!1,key:"imagefile_thumbnail_url",width:60},{title:a("EntriesView.headers.name"),sortable:!0,key:"name"},{title:a("EntriesView.headers.creator"),sortable:!0,key:"creator"},{title:a("EntriesView.headers.entryfile"),sortable:!1,key:"entryfile_url"},{title:a("EntriesView.headers.compo"),sortable:!1,key:"compo"},{title:a("EntriesView.headers.disqualified"),sortable:!1,key:"disqualified"},{title:a("EntriesView.headers.rank"),sortable:!1,key:"rank"},{title:a("EntriesView.headers.actions"),sortable:!1,key:"actions",align:"end"}],H=D(()=>[{title:a("EntriesView.allCompos"),value:null},...v.value.map(t=>({title:t.name,value:t.id}))]);function J(t){return v.value.find(e=>e.id===t)?.name??`#${t}`}function Z(){p.value&&q(p.value)}async function T(){try{const t=await we({path:{event_pk:i.value},query:{limit:100}});v.value=t.data.results}catch(t){console.error("Failed to load compos:",t)}}async function q(t){w.value=!0,p.value=t;try{const n=await A({path:{event_pk:M(g.eventId,10)},query:{...Ne(t),...d.value?{compo:d.value}:{}}});P.value=n.data.results,N.value=n.data.count}catch(n){m.error(a("EntriesView.loadFailure")),console.error(n)}finally{w.value=!1}}const _=Re(q,250);$(d,()=>{p.value&&_(p.value)});function Q(){d.value=null,y.value="",T(),_({page:1,itemsPerPage:h.value??25,sortBy:[],groupBy:[],search:""})}$(i,Q);async function W(t){const n=a("EntriesView.confirmDelete",t);await Y.value.ifConfirmed(n,async()=>{try{await Ve({path:{event_pk:i.value,id:t.id}}),m.success(a("EntriesView.deleteSuccess")),Z()}catch(e){m.error(Pe(e,a("EntriesView.deleteFailure"))),console.error(e)}})}function X(t){R.push({name:"entries-edit",params:{eventId:i.value,id:t}})}function ee(){R.push({name:"entries-new",params:{eventId:i.value}})}function te(t){return"I".repeat(t)}function ae(t){const n=new Map;for(const u of t){const k=n.get(u.compo)??[];k.push(u),n.set(u.compo,k)}const e=[];for(const u of v.value){const se=[...n.get(u.id)??[]].sort((c,b)=>c.rank===null&&b.rank===null?0:c.rank===null?1:b.rank===null?-1:c.rank-b.rank).slice(0,3);for(const c of se)c.rank!==null&&e.push([c.name,c.creator,te(c.rank),u.name])}return e}async function ne(t){V.value=!0;try{const n=await A({path:{event_pk:i.value},query:{limit:1e4}}),e=ae(n.data.results);be(e,"instanssi_entries",t,"Results"),m.success(a("EntriesView.exportSuccess"))}catch(n){m.error(a("EntriesView.exportFailure")),console.error(n)}finally{V.value=!1}}return de(()=>{T()}),(t,n)=>(x(),F(Ce,{key:`entries-${i.value}`,breadcrumbs:G.value},{default:o(()=>[l(L,null,{default:o(()=>[l(K,null,{default:o(()=>[s(f).canAdd(s(E).ENTRY)?(x(),F(me,{key:0,onClick:ee},{prepend:o(()=>[l(s(pe),{icon:s(fe)},null,8,["icon"])]),default:o(()=>[C(" "+I(s(a)("EntriesView.newEntry")),1)]),_:1})):S("",!0),s(f).canView(s(E).ENTRY)?(x(),ve("div",Te,[l(ke,{label:s(a)("EntriesView.exportResults"),loading:V.value,onExport:ne},null,8,["label","loading"])])):S("",!0),l(ye,{modelValue:d.value,"onUpdate:modelValue":n[0]||(n[0]=e=>d.value=e),items:H.value,variant:"outlined",density:"compact",label:s(a)("EntriesView.filterByCompo"),style:{"max-width":"300px"},class:"ma-0 pa-0 ml-4",clearable:""},null,8,["modelValue","items","label"]),l(Ee,{modelValue:y.value,"onUpdate:modelValue":n[1]||(n[1]=e=>y.value=e),variant:"outlined",density:"compact",label:s(a)("General.search"),style:{"max-width":"400px"},class:"ma-0 pa-0 ml-4",clearable:""},null,8,["modelValue","label"])]),_:1})]),_:1}),l(L,null,{default:o(()=>[l(K,null,{default:o(()=>[l(Be,{"items-per-page":h.value,"onUpdate:itemsPerPage":n[2]||(n[2]=e=>h.value=e),class:"elevation-1 primary","item-value":"id",density:"compact",headers:z,items:P.value,"items-length":N.value,loading:w.value,search:y.value,page:O.value,"items-per-page-options":B,"no-data-text":s(a)("EntriesView.noEntriesFound"),"loading-text":s(a)("EntriesView.loadingEntries"),"onUpdate:options":s(_)},{"item.imagefile_thumbnail_url":o(({item:e})=>[l(xe,{url:e.imagefile_thumbnail_url},null,8,["url"])]),"item.entryfile_url":o(({item:e})=>[l(Ie,{url:e.entryfile_url},null,8,["url"])]),"item.disqualified":o(({item:e})=>[l(_e,{value:e.disqualified,"true-class":"text-red","false-class":"text-green"},null,8,["value"])]),"item.compo":o(({item:e})=>[C(I(J(e.compo)),1)]),"item.rank":o(({item:e})=>[C(I(e.rank??"-"),1)]),"item.actions":o(({item:e})=>[l(De,{"can-edit":s(f).canChange(s(E).ENTRY),"can-delete":s(f).canDelete(s(E).ENTRY),onEdit:u=>X(e.id),onDelete:u=>W(e)},null,8,["can-edit","can-delete","onEdit","onDelete"])]),_:1},8,["items-per-page","items","items-length","loading","search","page","no-data-text","loading-text","onUpdate:options"])]),_:1})]),_:1})]),_:1},8,["breadcrumbs"]))}});export{Je as default};
//# sourceMappingURL=EntriesView-CEtpI8Fo.js.map
