import{d as ne,a as se,u as oe,H as le,I as re,v as ie,a1 as ue,o as ce,b as k,g as B,w as o,e as l,j as s,P as E,V as de,i as b,t as x,k as me,J as pe,K as F,c as fe,a2 as ve,m as Ee,q as ye,G as C,s as r,af as ge,an as we,ao as P,E as Ve}from"./index-BSHMv_df.js";import{_ as he}from"./BooleanIcon.vue_vue_type_script_setup_true_lang-COcceYO8.js";import{_ as _e,d as ke}from"./spreadsheet-BhwIOQCz.js";import{I as be}from"./ImageCell-yz-yO6nd.js";import{V as S,_ as xe}from"./LayoutBase.vue_vue_type_script_setup_true_lang-C8aKWyeJ.js";import{M as Ce}from"./MediaCell-xXvaknan.js";import{_ as Ie}from"./TableActionButtons.vue_vue_type_script_setup_true_lang-DouyropJ.js";import{d as De,V as Re,g as Ne}from"./query_tools-Co6bP9h2.js";import{g as Te}from"./http-BZkoYM_m.js";import{V as A}from"./VRow-BUBfmFS3.js";import{p as L}from"./parseInt-3OpbdfxQ.js";import"./VContainer--EpXOfw5.js";import"./VDataTable-CpUosGjF.js";import"./filter-C6Uu0LOB.js";const qe={key:1,class:"ml-4"},He=ne({__name:"EntriesView",props:{eventId:{}},setup(K){const y=K,{t:a}=se(),I=oe(),M=le(re),d=ie(),f=ye(),{getEventById:U}=Ve(),c=C(()=>L(y.eventId,10)),g=r(!1),w=r(!1),Y=C(()=>[{title:U(c.value)?.name??"...",to:{name:"dashboard",params:{eventId:y.eventId}}},{title:a("EntriesView.title"),disabled:!0}]),D=[25,50,100],R=r(D[0]),N=r(0),j=r(1),T=r([]),v=r([]),V=r(""),m=r(null),p=r(null),G=[{title:a("EntriesView.headers.id"),sortable:!0,key:"id"},{title:a("EntriesView.headers.image"),sortable:!1,key:"imagefile_thumbnail_url",width:60},{title:a("EntriesView.headers.name"),sortable:!0,key:"name"},{title:a("EntriesView.headers.creator"),sortable:!0,key:"creator"},{title:a("EntriesView.headers.entryfile"),sortable:!1,key:"entryfile_url"},{title:a("EntriesView.headers.compo"),sortable:!1,key:"compo"},{title:a("EntriesView.headers.disqualified"),sortable:!1,key:"disqualified"},{title:a("EntriesView.headers.rank"),sortable:!0,key:"rank"},{title:a("EntriesView.headers.actions"),sortable:!1,key:"actions",align:"end"}],O=C(()=>[{title:a("EntriesView.allCompos"),value:null},...v.value.map(t=>({title:t.name,value:t.id}))]);function z(t){return v.value.find(e=>e.id===t)?.name??`#${t}`}function H(){p.value&&q(p.value)}async function J(){try{const t=await ge({path:{event_pk:c.value},query:{limit:100}});v.value=t.data.results}catch(t){console.error("Failed to load compos:",t)}}async function q(t){g.value=!0,p.value=t;try{const n=await P({path:{event_pk:L(y.eventId,10)},query:{...Ne(t),...m.value?{compo:m.value}:{}}});T.value=n.data.results,N.value=n.data.count}catch(n){d.error(a("EntriesView.loadFailure")),console.error(n)}finally{g.value=!1}}const $=De(q,250);ue(m,()=>{p.value&&$(p.value)});async function Q(t){const n=a("EntriesView.confirmDelete",t);await M.value.ifConfirmed(n,async()=>{try{await we({path:{event_pk:c.value,id:t.id}}),d.success(a("EntriesView.deleteSuccess")),H()}catch(e){d.error(Te(e,a("EntriesView.deleteFailure"))),console.error(e)}})}function W(t){I.push({name:"entries-edit",params:{eventId:c.value,id:t}})}function X(){I.push({name:"entries-new",params:{eventId:c.value}})}function Z(t){return"I".repeat(t)}function ee(t){const n=new Map;for(const i of t){const h=n.get(i.compo)??[];h.push(i),n.set(i.compo,h)}const e=[];for(const i of v.value){const ae=[...n.get(i.id)??[]].sort((u,_)=>u.rank===null&&_.rank===null?0:u.rank===null?1:_.rank===null?-1:u.rank-_.rank).slice(0,3);for(const u of ae)u.rank!==null&&e.push([u.name,u.creator,Z(u.rank),i.name])}return e}async function te(t){w.value=!0;try{const n=await P({path:{event_pk:c.value},query:{limit:1e4}}),e=ee(n.data.results);ke(e,"instanssi_entries",t,"Results"),d.success(a("EntriesView.exportSuccess"))}catch(n){d.error(a("EntriesView.exportFailure")),console.error(n)}finally{w.value=!1}}return ce(()=>{J()}),(t,n)=>(k(),B(xe,{key:`entries-${c.value}`,breadcrumbs:Y.value},{default:o(()=>[l(S,null,{default:o(()=>[l(A,null,{default:o(()=>[s(f).canAdd(s(E).ENTRY)?(k(),B(de,{key:0,onClick:X},{prepend:o(()=>[l(s(me),{icon:s(pe)},null,8,["icon"])]),default:o(()=>[b(" "+x(s(a)("EntriesView.newEntry")),1)]),_:1})):F("",!0),s(f).canView(s(E).ENTRY)?(k(),fe("div",qe,[l(_e,{label:s(a)("EntriesView.exportResults"),loading:w.value,onExport:te},null,8,["label","loading"])])):F("",!0),l(ve,{modelValue:m.value,"onUpdate:modelValue":n[0]||(n[0]=e=>m.value=e),items:O.value,variant:"outlined",density:"compact",label:s(a)("EntriesView.filterByCompo"),style:{"max-width":"300px"},class:"ma-0 pa-0 ml-4",clearable:""},null,8,["modelValue","items","label"]),l(Ee,{modelValue:V.value,"onUpdate:modelValue":n[1]||(n[1]=e=>V.value=e),variant:"outlined",density:"compact",label:s(a)("General.search"),style:{"max-width":"400px"},class:"ma-0 pa-0 ml-4",clearable:""},null,8,["modelValue","label"])]),_:1})]),_:1}),l(S,null,{default:o(()=>[l(A,null,{default:o(()=>[l(Re,{"items-per-page":R.value,"onUpdate:itemsPerPage":n[2]||(n[2]=e=>R.value=e),class:"elevation-1 primary","item-value":"id",density:"compact",headers:G,items:T.value,"items-length":N.value,loading:g.value,search:V.value,page:j.value,"items-per-page-options":D,"no-data-text":s(a)("EntriesView.noEntriesFound"),"loading-text":s(a)("EntriesView.loadingEntries"),"onUpdate:options":s($)},{"item.imagefile_thumbnail_url":o(({item:e})=>[l(be,{url:e.imagefile_thumbnail_url},null,8,["url"])]),"item.entryfile_url":o(({item:e})=>[l(Ce,{url:e.entryfile_url},null,8,["url"])]),"item.disqualified":o(({item:e})=>[l(he,{value:e.disqualified,"true-class":"text-red","false-class":"text-green"},null,8,["value"])]),"item.compo":o(({item:e})=>[b(x(z(e.compo)),1)]),"item.rank":o(({item:e})=>[b(x(e.rank??"-"),1)]),"item.actions":o(({item:e})=>[l(Ie,{"can-edit":s(f).canChange(s(E).ENTRY),"can-delete":s(f).canDelete(s(E).ENTRY),onEdit:i=>W(e.id),onDelete:i=>Q(e)},null,8,["can-edit","can-delete","onEdit","onDelete"])]),_:1},8,["items-per-page","items","items-length","loading","search","page","no-data-text","loading-text","onUpdate:options"])]),_:1})]),_:1})]),_:1},8,["breadcrumbs"]))}});export{He as default};
//# sourceMappingURL=EntriesView-Cq9gorZF.js.map
