import{d as re,a as ue,u as me,J as de,K as ce,v as pe,L as A,o as fe,b as w,g as N,w as i,e as n,j as e,P as E,V as $,i as h,t as b,k as L,M as ve,D as I,c as ye,ay as ge,m as Ee,N as O,O as Ve,q as we,I as k,s as c,aq as he,az as be,aA as U,H as ke}from"./index-CQkWvXOv.js";import{_ as _e}from"./BooleanIcon.vue_vue_type_script_setup_true_lang-BUZkEwsX.js";import{_ as xe,d as De}from"./spreadsheet-B6MwOGQk.js";import{I as Ce}from"./ImageCell-BlQ2k2ZF.js";import{V as K,_ as qe}from"./LayoutBase.vue_vue_type_script_setup_true_lang-D5aCeQDf.js";import{M as Ne}from"./MediaCell-DVuUxSBK.js";import{_ as Ie}from"./TableActionButtons.vue_vue_type_script_setup_true_lang-DepTf6Bi.js";import{u as Re,d as Be}from"./useTableState-CutuDm2i.js";import{g as Fe}from"./query_tools-BInV9OzK.js";import{_ as Pe,t as Se}from"./DiplomaGeneratorDialog.vue_vue_type_script_setup_true_lang-CPwzGiJj.js";import{g as Te}from"./http-CET7UDul.js";import{V as M}from"./VRow-CXIXhuhq.js";import{V as Ae}from"./VDataTableServer-C6tuZDKn.js";import{p as Y}from"./parseInt-BJ5A4_3y.js";import"./VContainer-DqJ8gu3P.js";import"./AuditLogDialog.vue_vue_type_script_setup_true_lang-1MnYozFL.js";import"./useAuditLogUtils-BdjF9k7b.js";import"./DateTimeCell.vue_vue_type_script_setup_true_lang-DaLynL44.js";import"./datetime-Dz9fjSvq.js";import"./_commonjsHelpers-CqkleIqs.js";import"./VAlert-BCBb7cPR.js";import"./VDataTable-f5_9vewM.js";const $e={key:1,class:"ml-4"},rt=re({__name:"EntriesView",props:{eventId:{}},setup(G){const _=G,{t:a}=ue(),R=me(),j=de(ce),f=pe(),v=we(),{getEventById:z}=ke(),u=k(()=>Y(_.eventId,10)),x=c(!1),D=c(!1),B=c(void 0),H=k(()=>[{title:z(u.value)?.name??"...",to:{name:"dashboard",params:{eventId:_.eventId}}},{title:a("EntriesView.title"),disabled:!0}]),o=Re({filterKeys:["compo","disqualified"]}),F=c(0),P=c([]),V=c([]),y=c(null),g=k({get:()=>o.getFilterAsNumber("compo"),set:l=>{o.setFilter("compo",l),o.resetPage()}}),p=o.useBooleanFilter("disqualified"),J=[{title:a("EntriesView.headers.id"),sortable:!0,key:"id"},{title:a("EntriesView.headers.image"),sortable:!1,key:"imagefile_thumbnail_url",width:60},{title:a("EntriesView.headers.name"),sortable:!0,key:"name"},{title:a("EntriesView.headers.creator"),sortable:!0,key:"creator"},{title:a("EntriesView.headers.entryfile"),sortable:!1,key:"entryfile_url"},{title:a("EntriesView.headers.compo"),sortable:!0,key:"compo"},{title:a("EntriesView.headers.disqualified"),sortable:!1,key:"disqualified"},{title:a("EntriesView.headers.rank"),sortable:!1,key:"rank"},{title:a("EntriesView.headers.actions"),sortable:!1,key:"actions",align:"end"}],Q=k(()=>[{title:a("EntriesView.allCompos"),value:null},...V.value.map(l=>({title:l.name,value:l.id}))]);function W(l){return V.value.find(t=>t.id===l)?.name??`#${l}`}function X(){y.value&&T(y.value)}async function S(){try{const l=await he({path:{event_pk:u.value},query:{limit:100}});V.value=l.data.results}catch(l){console.error("Failed to load compos:",l)}}async function T(l){x.value=!0,y.value=l;try{const s=await U({path:{event_pk:Y(_.eventId,10)},query:{...Fe(l),...g.value?{compo:g.value}:{},...p.value!==null?{disqualified:p.value}:{}}});P.value=s.data.results,F.value=s.data.count}catch(s){f.error(a("EntriesView.loadFailure")),console.error(s)}finally{x.value=!1}}const C=Be(T,250);function Z(l){o.onOptionsUpdate(l),C(l)}A([g,p],()=>{y.value&&C({...y.value,page:1})});function ee(){o.setFilter("compo",null),o.setFilter("disqualified",null),o.search.value="",o.page.value=1,S(),C({page:1,itemsPerPage:o.perPage.value??25,sortBy:[],groupBy:[],search:""})}A(u,ee);async function te(l){const s=a("EntriesView.confirmDelete",l);await j.value.ifConfirmed(s,async()=>{try{await be({path:{event_pk:u.value,id:l.id}}),f.success(a("EntriesView.deleteSuccess")),X()}catch(t){f.error(Te(t,a("EntriesView.deleteFailure"))),console.error(t)}})}function ae(l){R.push({name:"entries-edit",params:{eventId:u.value,id:l}})}function le(){R.push({name:"entries-new",params:{eventId:u.value}})}function se(){B.value?.open()}function oe(l){const s=new Map;for(const r of l){const m=s.get(r.compo)??[];m.push(r),s.set(r.compo,m)}const t=[];for(const r of V.value){const ie=[...s.get(r.id)??[]].sort((d,q)=>d.rank===null&&q.rank===null?0:d.rank===null?1:q.rank===null?-1:d.rank-q.rank).slice(0,3);for(const d of ie)d.rank!==null&&t.push({entryName:d.name,creator:d.creator,rankString:Se(d.rank),compoName:r.name})}return t}async function ne(l){D.value=!0;try{const s=await U({path:{event_pk:u.value},query:{limit:1e4}}),r=oe(s.data.results).map(m=>[m.entryName,m.creator,m.rankString,m.compoName]);De(r,"instanssi_entries",l,"Results"),f.success(a("EntriesView.exportSuccess"))}catch(s){f.error(a("EntriesView.exportFailure")),console.error(s)}finally{D.value=!1}}return fe(()=>{S()}),(l,s)=>(w(),N(qe,{key:`entries-${u.value}`,breadcrumbs:H.value},{default:i(()=>[n(K,null,{default:i(()=>[n(M,null,{default:i(()=>[e(v).canAdd(e(E).ENTRY)?(w(),N($,{key:0,color:"primary",onClick:le},{prepend:i(()=>[n(e(L),{icon:e(ve)},null,8,["icon"])]),default:i(()=>[h(" "+b(e(a)("EntriesView.newEntry")),1)]),_:1})):I("",!0),e(v).canView(e(E).ENTRY)?(w(),ye("div",$e,[n(xe,{label:e(a)("EntriesView.exportResults"),loading:D.value,onExport:ne},null,8,["label","loading"])])):I("",!0),e(v).canView(e(E).ENTRY)?(w(),N($,{key:2,color:"secondary",class:"ml-4",onClick:se},{prepend:i(()=>[n(e(L),{icon:e(ge)},null,8,["icon"])]),default:i(()=>[h(" "+b(e(a)("DiplomaGenerator.title")),1)]),_:1})):I("",!0),n(Ee,{modelValue:e(o).search.value,"onUpdate:modelValue":s[0]||(s[0]=t=>e(o).search.value=t),variant:"outlined",density:"compact",label:e(a)("General.search"),style:{"max-width":"400px"},class:"ma-0 pa-0 ml-4",clearable:""},null,8,["modelValue","label"]),n(O,{modelValue:g.value,"onUpdate:modelValue":s[1]||(s[1]=t=>g.value=t),items:Q.value,variant:"outlined",density:"compact",label:e(a)("EntriesView.filterByCompo"),style:{"max-width":"300px"},class:"ma-0 pa-0 ml-4",clearable:""},null,8,["modelValue","items","label"]),n(O,{modelValue:e(p),"onUpdate:modelValue":s[2]||(s[2]=t=>Ve(p)?p.value=t:null),items:[{title:e(a)("EntriesView.allStatuses"),value:null},{title:e(a)("General.disqualifiedOn"),value:!0},{title:e(a)("General.disqualifiedOff"),value:!1}],variant:"outlined",density:"compact",label:e(a)("EntriesView.filterByDisqualified"),style:{"max-width":"200px"},class:"ma-0 pa-0 ml-4"},null,8,["modelValue","items","label"])]),_:1})]),_:1}),n(K,null,{default:i(()=>[n(M,null,{default:i(()=>[n(Ae,{"items-per-page":e(o).perPage.value,"onUpdate:itemsPerPage":s[3]||(s[3]=t=>e(o).perPage.value=t),"sort-by":e(o).sortByArray.value,class:"elevation-1 primary","item-value":"id",density:"compact",headers:J,items:P.value,"items-length":F.value,loading:x.value,search:e(o).search.value,page:e(o).page.value,"items-per-page-options":e(o).pageSizeOptions,"no-data-text":e(a)("EntriesView.noEntriesFound"),"loading-text":e(a)("EntriesView.loadingEntries"),"onUpdate:options":Z},{"item.imagefile_thumbnail_url":i(({item:t})=>[n(Ce,{url:t.imagefile_thumbnail_url},null,8,["url"])]),"item.entryfile_url":i(({item:t})=>[n(Ne,{url:t.entryfile_url},null,8,["url"])]),"item.disqualified":i(({item:t})=>[n(_e,{value:t.disqualified,"true-class":"text-red","false-class":"text-green"},null,8,["value"])]),"item.compo":i(({item:t})=>[h(b(W(t.compo)),1)]),"item.rank":i(({item:t})=>[h(b(t.rank??"-"),1)]),"item.actions":i(({item:t})=>[n(Ie,{"can-edit":e(v).canChange(e(E).ENTRY),"can-delete":e(v).canDelete(e(E).ENTRY),"audit-log":{appLabel:"kompomaatti",model:"entry",objectPk:t.id},onEdit:r=>ae(t.id),onDelete:r=>te(t)},null,8,["can-edit","can-delete","audit-log","onEdit","onDelete"])]),_:1},8,["items-per-page","sort-by","items","items-length","loading","search","page","items-per-page-options","no-data-text","loading-text"])]),_:1})]),_:1}),n(Pe,{ref_key:"diplomaDialog",ref:B,"event-id":u.value},null,8,["event-id"])]),_:1},8,["breadcrumbs"]))}});export{rt as default};
//# sourceMappingURL=EntriesView-DQzaSDf0.js.map
