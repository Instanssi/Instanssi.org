import{d as Se,a as he,u as Re,v as Be,aI as Ae,aJ as $e,o as Le,aK as Te,b as m,g as v,w as s,e as r,A as je,p as De,B as Ne,l as Pe,j as e,m as I,a3 as Ge,i as b,t as n,D as w,f as U,c as re,F as ie,aL as Ke,r as Oe,at as ze,k as se,aH as He,C as Qe,E as Je,V as oe,G as We,s as f,I as d,ap as Xe,T as Ye,H as Ze}from"./index-DXU74lGt.js";import{c as ea,f as K,a as V,d as aa,g as ue,u as la,b as o}from"./index.esm-DWTrtXO7.js";import{_ as ta}from"./AuditLogButton.vue_vue_type_script_setup_true_lang-5kFykphF.js";import{V as ra,_ as ia}from"./DisqualificationField.vue_vue_type_script_setup_true_lang-Dxhy7agJ.js";import{F as ne}from"./FileUploadField-IUZ2yZIA.js";import{F}from"./FormSection-ByskKXOp.js";import{I as sa}from"./ImageUploadField-B2rhKaF2.js";import{V as u,_ as oa}from"./LayoutBase.vue_vue_type_script_setup_true_lang-D4jd1chv.js";import{g as O,t as de,p as ua}from"./formdata-BXUVcBgf.js";import{h as me}from"./http-BTZWMaMN.js";import{p as z}from"./parseInt-Bzw_2rWL.js";import{V as na}from"./VForm-C430u1Uz.js";import{V as x}from"./VRow-B94Tto0H.js";import{V as da}from"./VTextarea-DeKWRVbT.js";import"./AuditLogDialog.vue_vue_type_script_setup_true_lang-WkXOSlqa.js";import"./useAuditLogUtils-BqNOieoY.js";import"./DateTimeCell.vue_vue_type_script_setup_true_lang-BMnBYvTq.js";import"./datetime-Dz9fjSvq.js";import"./VDataTableServer-CMLVDy59.js";import"./VDataTable-Jd7io3gq.js";import"./VSwitch-DB1fJMny.js";import"./VContainer-BfWqa_tJ.js";const ma={class:"text-body-2 text-medium-emphasis"},ca={class:"text-h6"},fa={class:"text-body-2 text-medium-emphasis"},pa={class:"text-h6"},La=Se({__name:"EntryEditView",props:{eventId:{},id:{}},setup(ce){const H={name:"name",creator:"creator",description:"description",compo:"compo",user:"user",platform:"platform",entryfile:"entryFile",sourcefile:"sourceFile",imagefile_original:"imageFile",youtube_url:"youtubeUrl",disqualified:"disqualified",disqualified_reason:"disqualifiedReason"},p=ce,{t:i}=he(),fe=Re(),g=Be(),{getEventById:pe}=Ze(),C=f(!1),M=f(!1),Q=f(""),E=d(()=>z(p.eventId,10)),c=d(()=>p.id!==void 0),q=f([]),J=f([]),y=f(null),W=f("-"),X=f("-"),S=f([]),ve=d(()=>{const l=[{title:pe(E.value)?.name??"...",to:{name:"dashboard",params:{eventId:p.eventId}}},{title:i("EntriesView.title"),to:{name:"entries",params:{eventId:p.eventId}}}];return c.value?l.push({title:Q.value||"...",disabled:!0}):l.push({title:i("Breadcrumbs.newEntry"),disabled:!0}),l}),be=d(()=>q.value.map(l=>({title:l.name,value:l.id}))),ye=d(()=>J.value.map(l=>({title:l.username,value:l.id})));function Ve(l){return l?q.value.find(a=>a.id===l)??null:null}const ge=ea({name:V().required().min(1).max(64),creator:V().required().min(1).max(64),description:V(),compo:ue().nullable().required(),user:ue().nullable().required(),platform:V().nullable(),youtubeUrl:V().nullable(),disqualified:aa(),disqualifiedReason:V(),entryFile:K().nullable().test("entry-file-required",i("EntryEditView.entryFileRequired"),l=>!!(O(l)||l===void 0&&y.value?.entryfile_url)),sourceFile:K().nullable(),imageFile:K().nullable().test("image-file-required",i("EntryEditView.imageFileRequired"),function(l){const a=this.parent.compo;return!!(!(Ve(a)?.thumbnail_pref===0)||O(l)||l===void 0&&y.value?.imagefile_original_url)})}),{handleSubmit:Ee,setValues:_e,setErrors:Y,meta:we}=la({validationSchema:ge,initialValues:{name:"",creator:"",description:"",compo:null,user:null,platform:"",youtubeUrl:"",disqualified:!1,disqualifiedReason:"",entryFile:void 0,sourceFile:void 0,imageFile:void 0}}),h=o("name"),R=o("creator"),B=o("description"),k=o("compo"),A=o("user"),$=o("platform"),L=o("youtubeUrl"),T=o("disqualified"),j=o("disqualifiedReason"),D=o("entryFile"),Z=o("sourceFile"),N=o("imageFile"),_=d(()=>{const l=k.value.value;return l?q.value.find(a=>a.id===l)??null:null});function P(l){if(l)return l.split("|").filter(Boolean).map(a=>`.${a}`).join(",")}const Fe=d(()=>P(_.value?.formats)),qe=d(()=>P(_.value?.source_formats)),ke=d(()=>P(_.value?.image_formats)),ee=d(()=>{const l=_.value?.thumbnail_pref;return l===0||l===2}),Ie=d(()=>_.value?.thumbnail_pref===0),ae=Ee(async l=>{M.value=!0;let a;c.value?a=await xe(z(p.id,10),l):a=await Ue(l),M.value=!1,a&&G()});function le(l,a){const t=a?O:ua;return{name:l.name,creator:l.creator,description:l.description||"",compo:a?l.compo:void 0,user:a?l.user:void 0,platform:l.platform||null,entryfile:t(l.entryFile),sourcefile:t(l.sourceFile),imagefile_original:ee.value?t(l.imageFile):void 0,youtube_url:l.youtubeUrl||null,disqualified:l.disqualified,disqualified_reason:l.disqualifiedReason||""}}async function Ue(l){const a=le(l,!0);try{return await Ae({path:{event_pk:E.value},body:a,bodySerializer:()=>de(a)}),g.success(i("EntryEditView.createSuccess")),!0}catch(t){me(t,Y,g,i("EntryEditView.createFailure"),H)}return!1}async function xe(l,a){const t=le(a,!1);try{return await $e({path:{event_pk:E.value,id:l},body:t,bodySerializer:()=>de(t)}),g.success(i("EntryEditView.editSuccess")),!0}catch(te){me(te,Y,g,i("EntryEditView.editFailure"),H)}return!1}function G(){fe.push({name:"entries",params:{eventId:p.eventId}})}async function Ce(){try{const l=await Xe({path:{event_pk:E.value},query:{limit:100}});q.value=l.data.results}catch(l){console.error("Failed to load compos:",l)}}async function Me(){try{const l=await Ye({query:{limit:1e3}});J.value=l.data.results}catch(l){console.error("Failed to load users:",l)}}return Le(async()=>{if(await Promise.all([Ce(),Me()]),c.value){C.value=!0;try{const a=(await Te({path:{event_pk:E.value,id:z(p.id,10)}})).data;Q.value=a.name,y.value={entryfile_url:a.entryfile_url,sourcefile_url:a.sourcefile_url,imagefile_original_url:a.imagefile_original_url},W.value=a.score?.toString()??"-",X.value=a.rank?.toString()??"-",S.value=a.alternate_files??[],_e({name:a.name,creator:a.creator,description:a.description??"",compo:a.compo,user:a.user,platform:a.platform??"",youtubeUrl:a.youtube_url??"",disqualified:a.disqualified??!1,disqualifiedReason:a.disqualified_reason??""})}catch(l){g.error(i("EntryEditView.loadFailure")),console.error(l),G()}finally{C.value=!1}}}),(l,a)=>(m(),v(oa,{breadcrumbs:ve.value},{default:s(()=>[C.value?(m(),v(u,{key:0,class:"d-flex justify-center my-8"},{default:s(()=>[r(je,{indeterminate:"",size:"64"})]),_:1})):(m(),v(u,{key:1},{default:s(()=>[r(De,null,{default:s(()=>[r(Ne,null,{default:s(()=>[r(na,{onSubmit:Pe(e(ae),["prevent"])},{default:s(()=>[r(x,null,{default:s(()=>[r(u,{cols:"12",md:"6"},{default:s(()=>[r(I,{modelValue:e(h).value.value,"onUpdate:modelValue":a[0]||(a[0]=t=>e(h).value.value=t),"error-messages":e(h).errorMessage.value,variant:"outlined",label:e(i)("EntryEditView.labels.name")+" *"},null,8,["modelValue","error-messages","label"])]),_:1}),r(u,{cols:"12",md:"6"},{default:s(()=>[r(I,{modelValue:e(R).value.value,"onUpdate:modelValue":a[1]||(a[1]=t=>e(R).value.value=t),"error-messages":e(R).errorMessage.value,variant:"outlined",label:e(i)("EntryEditView.labels.creator")+" *"},null,8,["modelValue","error-messages","label"])]),_:1})]),_:1}),r(da,{modelValue:e(B).value.value,"onUpdate:modelValue":a[2]||(a[2]=t=>e(B).value.value=t),"error-messages":e(B).errorMessage.value,variant:"outlined",label:e(i)("EntryEditView.labels.description"),rows:"3"},null,8,["modelValue","error-messages","label"]),r(x,null,{default:s(()=>[r(u,{cols:"12",md:"4"},{default:s(()=>[r(Ge,{modelValue:e(k).value.value,"onUpdate:modelValue":a[3]||(a[3]=t=>e(k).value.value=t),modelModifiers:{number:!0},items:be.value,"error-messages":e(k).errorMessage.value,variant:"outlined",label:e(i)("EntryEditView.labels.compo")+" *",disabled:c.value},null,8,["modelValue","items","error-messages","label","disabled"])]),_:1}),r(u,{cols:"12",md:"4"},{default:s(()=>[r(I,{modelValue:e($).value.value,"onUpdate:modelValue":a[4]||(a[4]=t=>e($).value.value=t),"error-messages":e($).errorMessage.value,variant:"outlined",label:e(i)("EntryEditView.labels.platform")},null,8,["modelValue","error-messages","label"])]),_:1}),r(u,{cols:"12",md:"4"},{default:s(()=>[r(ra,{modelValue:e(A).value.value,"onUpdate:modelValue":a[5]||(a[5]=t=>e(A).value.value=t),modelModifiers:{number:!0},items:ye.value,"error-messages":e(A).errorMessage.value,variant:"outlined",label:e(i)("EntryEditView.labels.user")+" *",disabled:c.value},null,8,["modelValue","items","error-messages","label","disabled"])]),_:1})]),_:1}),r(F,null,{default:s(()=>[b(n(e(i)("EntryEditView.sections.files")),1)]),_:1}),r(x,null,{default:s(()=>[r(u,{cols:"12",md:"4"},{default:s(()=>[r(ne,{modelValue:e(D).value.value,"onUpdate:modelValue":a[6]||(a[6]=t=>e(D).value.value=t),"current-file-url":y.value?.entryfile_url,label:e(i)("EntryEditView.labels.entryfile"),"error-message":e(D).errorMessage.value,accept:Fe.value,required:""},null,8,["modelValue","current-file-url","label","error-message","accept"])]),_:1}),r(u,{cols:"12",md:"4"},{default:s(()=>[r(ne,{modelValue:e(Z).value.value,"onUpdate:modelValue":a[7]||(a[7]=t=>e(Z).value.value=t),"current-file-url":y.value?.sourcefile_url,label:e(i)("EntryEditView.labels.sourcefile"),accept:qe.value},null,8,["modelValue","current-file-url","label","accept"])]),_:1}),ee.value?(m(),v(u,{key:0,cols:"12",md:"4"},{default:s(()=>[r(sa,{modelValue:e(N).value.value,"onUpdate:modelValue":a[8]||(a[8]=t=>e(N).value.value=t),"current-image-url":y.value?.imagefile_original_url,label:e(i)("EntryEditView.labels.imagefile"),"error-message":e(N).errorMessage.value,accept:ke.value,required:Ie.value},null,8,["modelValue","current-image-url","label","error-message","accept","required"])]),_:1})):w("",!0)]),_:1}),r(F,null,{default:s(()=>[b(n(e(i)("EntryEditView.sections.media")),1)]),_:1}),r(I,{modelValue:e(L).value.value,"onUpdate:modelValue":a[9]||(a[9]=t=>e(L).value.value=t),"error-messages":e(L).errorMessage.value,variant:"outlined",label:e(i)("EntryEditView.labels.youtubeUrl"),placeholder:"e.g. https://www.youtube.com/watch?v=dQw4w9WgXcQ"},null,8,["modelValue","error-messages","label"]),c.value?(m(),v(F,{key:0},{default:s(()=>[b(n(e(i)("EntryEditView.sections.ranking")),1)]),_:1})):w("",!0),c.value?(m(),v(x,{key:1},{default:s(()=>[r(u,{cols:"6",md:"3"},{default:s(()=>[U("div",ma,n(e(i)("EntryEditView.labels.score")),1),U("div",ca,n(W.value),1)]),_:1}),r(u,{cols:"6",md:"3"},{default:s(()=>[U("div",fa,n(e(i)("EntryEditView.labels.rank")),1),U("div",pa,n(X.value),1)]),_:1})]),_:1})):w("",!0),r(F,null,{default:s(()=>[b(n(e(i)("EntryEditView.sections.disqualification")),1)]),_:1}),r(ia,{modelValue:e(T).value.value,"onUpdate:modelValue":a[10]||(a[10]=t=>e(T).value.value=t),reason:e(j).value.value,"onUpdate:reason":a[11]||(a[11]=t=>e(j).value.value=t),"error-message":e(T).errorMessage.value,"reason-error-message":e(j).errorMessage.value,"label-on":e(i)("EntryEditView.labels.disqualifiedOn"),"label-off":e(i)("EntryEditView.labels.disqualifiedOff"),"reason-label":e(i)("EntryEditView.labels.disqualifiedReason")},null,8,["modelValue","reason","error-message","reason-error-message","label-on","label-off","reason-label"]),c.value&&S.value.length>0?(m(),re(ie,{key:2},[r(F,null,{default:s(()=>[b(n(e(i)("EntryEditView.sections.alternateFiles")),1)]),_:1}),r(Ke,{density:"compact"},{default:s(()=>[(m(!0),re(ie,null,Oe(S.value,t=>(m(),v(ze,{key:t.url,href:t.url,target:"_blank",title:t.format,subtitle:t.url},{prepend:s(()=>[r(e(se),{icon:e(He),class:"mr-4"},null,8,["icon"])]),_:1},8,["href","title","subtitle"]))),128))]),_:1})],64)):w("",!0)]),_:1},8,["onSubmit"])]),_:1}),r(Qe,{class:"justify-end"},{default:s(()=>[c.value?(m(),v(ta,{key:0,"app-label":"kompomaatti",model:"entry","object-pk":p.id},null,8,["object-pk"])):w("",!0),r(Je),r(oe,{variant:"text",onClick:G},{default:s(()=>[b(n(e(i)("General.cancel")),1)]),_:1}),r(oe,{variant:"elevated",color:"primary",loading:M.value,disabled:!e(we).valid,onClick:e(ae)},{prepend:s(()=>[r(e(se),{icon:e(We)},null,8,["icon"])]),default:s(()=>[b(" "+n(e(i)("General.save")),1)]),_:1},8,["loading","disabled","onClick"])]),_:1})]),_:1})]),_:1}))]),_:1},8,["breadcrumbs"]))}});export{La as default};
//# sourceMappingURL=EntryEditView-CZ0jK5Mm.js.map
