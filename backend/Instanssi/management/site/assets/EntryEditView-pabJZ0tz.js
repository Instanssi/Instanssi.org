import{d as Se,a as he,u as Re,v as Be,aK as Ae,aL as $e,o as Ne,aM as Le,b as m,g as v,w as o,e as r,A as je,p as De,B as Pe,l as Te,j as e,m as I,N as Ge,i as b,t as n,D as w,f as U,c as re,F as ie,aN as Ke,r as Oe,au as ze,k as oe,aJ as Qe,C as Xe,E as He,V as se,G as Je,s as f,I as d,aq as We,X as Ye,H as Ze}from"./index-CQkWvXOv.js";import{c as ea,f as K,a as V,d as aa,g as ue,u as la,b as s}from"./index.esm-aFENq7CA.js";import{_ as ta}from"./AuditLogButton.vue_vue_type_script_setup_true_lang-DHg2h5we.js";import{V as ra,_ as ia}from"./DisqualificationField.vue_vue_type_script_setup_true_lang-B87D3QPJ.js";import{F as ne}from"./FileUploadField-Dqevnsfs.js";import{F}from"./FormSection-Drw9hFWe.js";import{I as oa}from"./ImageUploadField-CMHDwiai.js";import{V as u,_ as sa}from"./LayoutBase.vue_vue_type_script_setup_true_lang-D5aCeQDf.js";import{g as O,t as de,p as ua}from"./formdata-0PwnLkt-.js";import{h as me}from"./http-CET7UDul.js";import{p as z}from"./parseInt-BJ5A4_3y.js";import{V as na}from"./VForm-VvaADaOh.js";import{V as x}from"./VRow-CXIXhuhq.js";import{V as da}from"./VTextarea-CQIJ1p3t.js";import"./_commonjsHelpers-CqkleIqs.js";import"./AuditLogDialog.vue_vue_type_script_setup_true_lang-1MnYozFL.js";import"./useAuditLogUtils-BdjF9k7b.js";import"./DateTimeCell.vue_vue_type_script_setup_true_lang-DaLynL44.js";import"./datetime-Dz9fjSvq.js";import"./VDataTableServer-C6tuZDKn.js";import"./VDataTable-f5_9vewM.js";import"./VSwitch-JF6EcneO.js";import"./VContainer-DqJ8gu3P.js";const ma={class:"text-body-2 text-medium-emphasis"},ca={class:"text-h6"},fa={class:"text-body-2 text-medium-emphasis"},pa={class:"text-h6"},La=Se({__name:"EntryEditView",props:{eventId:{},id:{}},setup(ce){const Q={name:"name",creator:"creator",description:"description",compo:"compo",user:"user",platform:"platform",entryfile:"entryFile",sourcefile:"sourceFile",imagefile_original:"imageFile",youtube_url:"youtubeUrl",disqualified:"disqualified",disqualified_reason:"disqualifiedReason"},p=ce,{t:i}=he(),fe=Re(),g=Be(),{getEventById:pe}=Ze(),M=f(!1),C=f(!1),X=f(""),E=d(()=>z(p.eventId,10)),c=d(()=>p.id!==void 0),q=f([]),H=f([]),y=f(null),J=f("-"),W=f("-"),S=f([]),ve=d(()=>{const l=[{title:pe(E.value)?.name??"...",to:{name:"dashboard",params:{eventId:p.eventId}}},{title:i("EntriesView.title"),to:{name:"entries",params:{eventId:p.eventId}}}];return c.value?l.push({title:X.value||"...",disabled:!0}):l.push({title:i("Breadcrumbs.newEntry"),disabled:!0}),l}),be=d(()=>q.value.map(l=>({title:l.name,value:l.id}))),ye=d(()=>H.value.map(l=>({title:l.username,value:l.id})));function Ve(l){return l?q.value.find(a=>a.id===l)??null:null}const ge=ea({name:V().required().min(1).max(64),creator:V().required().min(1).max(64),description:V(),compo:ue().nullable().required(),user:ue().nullable().required(),platform:V().nullable(),youtubeUrl:V().nullable(),disqualified:aa(),disqualifiedReason:V(),entryFile:K().nullable().test("entry-file-required",i("EntryEditView.entryFileRequired"),l=>!!(O(l)||l===void 0&&y.value?.entryfile_url)),sourceFile:K().nullable(),imageFile:K().nullable().test("image-file-required",i("EntryEditView.imageFileRequired"),function(l){const a=this.parent.compo;return!!(!(Ve(a)?.thumbnail_pref===0)||O(l)||l===void 0&&y.value?.imagefile_original_url)})}),{handleSubmit:Ee,setValues:_e,setErrors:Y,meta:we}=la({validationSchema:ge,initialValues:{name:"",creator:"",description:"",compo:null,user:null,platform:"",youtubeUrl:"",disqualified:!1,disqualifiedReason:"",entryFile:void 0,sourceFile:void 0,imageFile:void 0}}),h=s("name"),R=s("creator"),B=s("description"),k=s("compo"),A=s("user"),$=s("platform"),N=s("youtubeUrl"),L=s("disqualified"),j=s("disqualifiedReason"),D=s("entryFile"),Z=s("sourceFile"),P=s("imageFile"),_=d(()=>{const l=k.value.value;return l?q.value.find(a=>a.id===l)??null:null});function T(l){if(l)return l.split("|").filter(Boolean).map(a=>`.${a}`).join(",")}const Fe=d(()=>T(_.value?.formats)),qe=d(()=>T(_.value?.source_formats)),ke=d(()=>T(_.value?.image_formats)),ee=d(()=>{const l=_.value?.thumbnail_pref;return l===0||l===2}),Ie=d(()=>_.value?.thumbnail_pref===0),ae=Ee(async l=>{C.value=!0;let a;c.value?a=await xe(z(p.id,10),l):a=await Ue(l),C.value=!1,a&&G()});function le(l,a){const t=a?O:ua;return{name:l.name,creator:l.creator,description:l.description||"",compo:a?l.compo:void 0,user:a?l.user:void 0,platform:l.platform||null,entryfile:t(l.entryFile),sourcefile:t(l.sourceFile),imagefile_original:ee.value?t(l.imageFile):void 0,youtube_url:l.youtubeUrl||null,disqualified:l.disqualified,disqualified_reason:l.disqualifiedReason||""}}async function Ue(l){const a=le(l,!0);try{return await Ae({path:{event_pk:E.value},body:a,bodySerializer:()=>de(a)}),g.success(i("EntryEditView.createSuccess")),!0}catch(t){me(t,Y,g,i("EntryEditView.createFailure"),Q)}return!1}async function xe(l,a){const t=le(a,!1);try{return await $e({path:{event_pk:E.value,id:l},body:t,bodySerializer:()=>de(t)}),g.success(i("EntryEditView.editSuccess")),!0}catch(te){me(te,Y,g,i("EntryEditView.editFailure"),Q)}return!1}function G(){fe.push({name:"entries",params:{eventId:p.eventId}})}async function Me(){try{const l=await We({path:{event_pk:E.value},query:{limit:100}});q.value=l.data.results}catch(l){console.error("Failed to load compos:",l)}}async function Ce(){try{const l=await Ye({query:{limit:1e3}});H.value=l.data.results}catch(l){console.error("Failed to load users:",l)}}return Ne(async()=>{if(await Promise.all([Me(),Ce()]),c.value){M.value=!0;try{const a=(await Le({path:{event_pk:E.value,id:z(p.id,10)}})).data;X.value=a.name,y.value={entryfile_url:a.entryfile_url,sourcefile_url:a.sourcefile_url,imagefile_original_url:a.imagefile_original_url},J.value=a.score?.toString()??"-",W.value=a.rank?.toString()??"-",S.value=a.alternate_files??[],_e({name:a.name,creator:a.creator,description:a.description??"",compo:a.compo,user:a.user,platform:a.platform??"",youtubeUrl:a.youtube_url??"",disqualified:a.disqualified??!1,disqualifiedReason:a.disqualified_reason??""})}catch(l){g.error(i("EntryEditView.loadFailure")),console.error(l),G()}finally{M.value=!1}}}),(l,a)=>(m(),v(sa,{breadcrumbs:ve.value},{default:o(()=>[M.value?(m(),v(u,{key:0,class:"d-flex justify-center my-8"},{default:o(()=>[r(je,{indeterminate:"",size:"64"})]),_:1})):(m(),v(u,{key:1},{default:o(()=>[r(De,null,{default:o(()=>[r(Pe,null,{default:o(()=>[r(na,{onSubmit:Te(e(ae),["prevent"])},{default:o(()=>[r(x,null,{default:o(()=>[r(u,{cols:"12",md:"6"},{default:o(()=>[r(I,{modelValue:e(h).value.value,"onUpdate:modelValue":a[0]||(a[0]=t=>e(h).value.value=t),"error-messages":e(h).errorMessage.value,variant:"outlined",label:e(i)("EntryEditView.labels.name")+" *"},null,8,["modelValue","error-messages","label"])]),_:1}),r(u,{cols:"12",md:"6"},{default:o(()=>[r(I,{modelValue:e(R).value.value,"onUpdate:modelValue":a[1]||(a[1]=t=>e(R).value.value=t),"error-messages":e(R).errorMessage.value,variant:"outlined",label:e(i)("EntryEditView.labels.creator")+" *"},null,8,["modelValue","error-messages","label"])]),_:1})]),_:1}),r(da,{modelValue:e(B).value.value,"onUpdate:modelValue":a[2]||(a[2]=t=>e(B).value.value=t),"error-messages":e(B).errorMessage.value,variant:"outlined",label:e(i)("EntryEditView.labels.description"),rows:"3"},null,8,["modelValue","error-messages","label"]),r(x,null,{default:o(()=>[r(u,{cols:"12",md:"4"},{default:o(()=>[r(Ge,{modelValue:e(k).value.value,"onUpdate:modelValue":a[3]||(a[3]=t=>e(k).value.value=t),modelModifiers:{number:!0},items:be.value,"error-messages":e(k).errorMessage.value,variant:"outlined",label:e(i)("EntryEditView.labels.compo")+" *",disabled:c.value},null,8,["modelValue","items","error-messages","label","disabled"])]),_:1}),r(u,{cols:"12",md:"4"},{default:o(()=>[r(I,{modelValue:e($).value.value,"onUpdate:modelValue":a[4]||(a[4]=t=>e($).value.value=t),"error-messages":e($).errorMessage.value,variant:"outlined",label:e(i)("EntryEditView.labels.platform")},null,8,["modelValue","error-messages","label"])]),_:1}),r(u,{cols:"12",md:"4"},{default:o(()=>[r(ra,{modelValue:e(A).value.value,"onUpdate:modelValue":a[5]||(a[5]=t=>e(A).value.value=t),modelModifiers:{number:!0},items:ye.value,"error-messages":e(A).errorMessage.value,variant:"outlined",label:e(i)("EntryEditView.labels.user")+" *",disabled:c.value},null,8,["modelValue","items","error-messages","label","disabled"])]),_:1})]),_:1}),r(F,null,{default:o(()=>[b(n(e(i)("EntryEditView.sections.files")),1)]),_:1}),r(x,null,{default:o(()=>[r(u,{cols:"12",md:"4"},{default:o(()=>[r(ne,{modelValue:e(D).value.value,"onUpdate:modelValue":a[6]||(a[6]=t=>e(D).value.value=t),"current-file-url":y.value?.entryfile_url,label:e(i)("EntryEditView.labels.entryfile"),"error-message":e(D).errorMessage.value,accept:Fe.value,required:""},null,8,["modelValue","current-file-url","label","error-message","accept"])]),_:1}),r(u,{cols:"12",md:"4"},{default:o(()=>[r(ne,{modelValue:e(Z).value.value,"onUpdate:modelValue":a[7]||(a[7]=t=>e(Z).value.value=t),"current-file-url":y.value?.sourcefile_url,label:e(i)("EntryEditView.labels.sourcefile"),accept:qe.value},null,8,["modelValue","current-file-url","label","accept"])]),_:1}),ee.value?(m(),v(u,{key:0,cols:"12",md:"4"},{default:o(()=>[r(oa,{modelValue:e(P).value.value,"onUpdate:modelValue":a[8]||(a[8]=t=>e(P).value.value=t),"current-image-url":y.value?.imagefile_original_url,label:e(i)("EntryEditView.labels.imagefile"),"error-message":e(P).errorMessage.value,accept:ke.value,required:Ie.value},null,8,["modelValue","current-image-url","label","error-message","accept","required"])]),_:1})):w("",!0)]),_:1}),r(F,null,{default:o(()=>[b(n(e(i)("EntryEditView.sections.media")),1)]),_:1}),r(I,{modelValue:e(N).value.value,"onUpdate:modelValue":a[9]||(a[9]=t=>e(N).value.value=t),"error-messages":e(N).errorMessage.value,variant:"outlined",label:e(i)("EntryEditView.labels.youtubeUrl"),placeholder:"e.g. https://www.youtube.com/watch?v=dQw4w9WgXcQ"},null,8,["modelValue","error-messages","label"]),c.value?(m(),v(F,{key:0},{default:o(()=>[b(n(e(i)("EntryEditView.sections.ranking")),1)]),_:1})):w("",!0),c.value?(m(),v(x,{key:1},{default:o(()=>[r(u,{cols:"6",md:"3"},{default:o(()=>[U("div",ma,n(e(i)("EntryEditView.labels.score")),1),U("div",ca,n(J.value),1)]),_:1}),r(u,{cols:"6",md:"3"},{default:o(()=>[U("div",fa,n(e(i)("EntryEditView.labels.rank")),1),U("div",pa,n(W.value),1)]),_:1})]),_:1})):w("",!0),r(F,null,{default:o(()=>[b(n(e(i)("EntryEditView.sections.disqualification")),1)]),_:1}),r(ia,{modelValue:e(L).value.value,"onUpdate:modelValue":a[10]||(a[10]=t=>e(L).value.value=t),reason:e(j).value.value,"onUpdate:reason":a[11]||(a[11]=t=>e(j).value.value=t),"error-message":e(L).errorMessage.value,"reason-error-message":e(j).errorMessage.value,"label-on":e(i)("EntryEditView.labels.disqualifiedOn"),"label-off":e(i)("EntryEditView.labels.disqualifiedOff"),"reason-label":e(i)("EntryEditView.labels.disqualifiedReason")},null,8,["modelValue","reason","error-message","reason-error-message","label-on","label-off","reason-label"]),c.value&&S.value.length>0?(m(),re(ie,{key:2},[r(F,null,{default:o(()=>[b(n(e(i)("EntryEditView.sections.alternateFiles")),1)]),_:1}),r(Ke,{density:"compact"},{default:o(()=>[(m(!0),re(ie,null,Oe(S.value,t=>(m(),v(ze,{key:t.url,href:t.url,target:"_blank",title:t.format,subtitle:t.url},{prepend:o(()=>[r(e(oe),{icon:e(Qe),class:"mr-4"},null,8,["icon"])]),_:1},8,["href","title","subtitle"]))),128))]),_:1})],64)):w("",!0)]),_:1},8,["onSubmit"])]),_:1}),r(Xe,{class:"justify-end"},{default:o(()=>[c.value?(m(),v(ta,{key:0,"app-label":"kompomaatti",model:"entry","object-pk":p.id},null,8,["object-pk"])):w("",!0),r(He),r(se,{variant:"text",onClick:G},{default:o(()=>[b(n(e(i)("General.cancel")),1)]),_:1}),r(se,{variant:"elevated",color:"primary",loading:C.value,disabled:!e(we).valid,onClick:e(ae)},{prepend:o(()=>[r(e(oe),{icon:e(Je)},null,8,["icon"])]),default:o(()=>[b(" "+n(e(i)("General.save")),1)]),_:1},8,["loading","disabled","onClick"])]),_:1})]),_:1})]),_:1}))]),_:1},8,["breadcrumbs"]))}});export{La as default};
//# sourceMappingURL=EntryEditView-pabJZ0tz.js.map
