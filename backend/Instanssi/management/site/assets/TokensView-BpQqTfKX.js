import{d as N,a as B,v as E,L as I,b as C,g as V,Y as q,j as e,Z as Y,w as o,e as n,m as H,f as z,t as S,l as G,s as c,$ as J,a0 as Z,i as R,V as F,k as U,a1 as Q,_ as W,J as X,K as ee,P as K,M as te,D as P,a2 as ae,q as oe,a3 as ne,a4 as se}from"./index-CQkWvXOv.js";import{_ as L}from"./DateTimeCell.vue_vue_type_script_setup_true_lang-DaLynL44.js";import{V as M,_ as ie}from"./LayoutBase.vue_vue_type_script_setup_true_lang-D5aCeQDf.js";import{h as le,g as re}from"./http-CET7UDul.js";import{V as ue}from"./VForm-VvaADaOh.js";import{V as ce}from"./VAlert-BCBb7cPR.js";import{u as de,d as pe}from"./useTableState-CutuDm2i.js";import{g as me}from"./query_tools-BInV9OzK.js";import{V as O}from"./VRow-CXIXhuhq.js";import{V as ke}from"./VDataTableServer-C6tuZDKn.js";import"./datetime-Dz9fjSvq.js";import"./VContainer-DqJ8gu3P.js";import"./VDataTable-f5_9vewM.js";const fe={class:"text-caption mt-2 text-medium-emphasis"},ge=N({__name:"TokenCreateDialog",props:{visible:{type:Boolean}},emits:["update:visible","created"],setup(b,{emit:s}){const v=b,f=s,{t}=B(),m=E(),k=c(void 0),d=c(!1),u=c(""),y=c(""),g=c(""),_={expiry:"expiry"};function w(a){g.value=a.expiry??""}function x(a){const r=T=>T.toString().padStart(2,"0");return`${a.getFullYear()}-${r(a.getMonth()+1)}-${r(a.getDate())}T${r(a.getHours())}:${r(a.getMinutes())}`}function $(){const a=new Date;return a.setDate(a.getDate()+30),x(a)}function h(){y.value=x(new Date),u.value=$(),g.value=""}I(()=>v.visible,async a=>{if(a){for(h();!(!await k.value?.modal()||await D()););f("update:visible",!1)}});async function D(){if(!u.value)return m.error(t("TokenCreateDialog.expiryRequired")),!1;const a=new Date(u.value);if(isNaN(a.getTime()))return m.error(t("TokenCreateDialog.expiryRequired")),!1;d.value=!0;try{const r=await J({body:{expiry:a.toISOString()}});return m.success(t("TokenCreateDialog.createSuccess")),f("created",r.data.token),!0}catch(r){return le(r,w,m,t("TokenCreateDialog.createFailure"),_),!1}finally{d.value=!1}}return(a,r)=>(C(),V(q,{ref_key:"dialog",ref:k,title:e(t)("TokenCreateDialog.title"),width:500,"ok-text":e(t)("TokenCreateDialog.create"),"ok-icon":e(Y),loading:d.value},{default:o(()=>[n(ue,{onSubmit:G(D,["prevent"])},{default:o(()=>[n(H,{modelValue:u.value,"onUpdate:modelValue":r[0]||(r[0]=T=>u.value=T),type:"datetime-local",variant:"outlined",label:e(t)("TokenCreateDialog.labels.expiry"),min:y.value,"error-messages":g.value},null,8,["modelValue","label","min","error-messages"]),z("p",fe,S(e(t)("TokenCreateDialog.expiryHint")),1)]),_:1})]),_:1},8,["title","ok-text","ok-icon","loading"]))}}),ve=N({__name:"TokenCreatedDialog",props:{visible:{type:Boolean},token:{}},emits:["update:visible"],setup(b,{emit:s}){const v=b,f=s,{t}=B(),m=E(),k=c(void 0);I(()=>v.visible,async u=>{u&&(await k.value?.modal(),f("update:visible",!1))});async function d(){try{await navigator.clipboard.writeText(v.token),m.success(t("TokenCreatedDialog.copySuccess"))}catch(u){m.error(t("TokenCreatedDialog.copyFailure")),console.error(u)}}return(u,y)=>(C(),V(q,{ref_key:"dialog",ref:k,title:e(t)("TokenCreatedDialog.title"),width:600,"ok-text":e(t)("General.ok"),"ok-icon":e(Z),"cancel-text":""},{default:o(()=>[n(ce,{type:"warning",variant:"tonal",class:"mb-4"},{default:o(()=>[R(S(e(t)("TokenCreatedDialog.warning")),1)]),_:1}),n(H,{"model-value":b.token,variant:"outlined",readonly:"",label:e(t)("TokenCreatedDialog.labels.token"),class:"token-field"},{"append-inner":o(()=>[n(F,{variant:"text",size:"small",title:e(t)("TokenCreatedDialog.copyToClipboard"),onClick:d},{default:o(()=>[n(e(U),{icon:e(Q)},null,8,["icon"])]),_:1},8,["title"])]),_:1},8,["model-value","label"])]),_:1},8,["title","ok-text","ok-icon"]))}}),ye=W(ve,[["__scopeId","data-v-8d680171"]]),Ue=N({__name:"TokensView",setup(b){const{t:s}=B(),v=X(ee),f=E(),t=oe(),m=[{title:s("TokensView.title"),disabled:!0}],k=c(!1),d=de(),u=c(0),y=c([]),g=c(null),_=c(!1),w=c(!1),x=c(""),$=[{title:s("TokensView.headers.tokenKey"),sortable:!1,key:"token_key"},{title:s("TokensView.headers.created"),sortable:!0,key:"created"},{title:s("TokensView.headers.expiry"),sortable:!0,key:"expiry"},{title:s("TokensView.headers.actions"),sortable:!1,key:"actions",align:"end"}];function h(){g.value&&D(g.value)}async function D(p){k.value=!0,g.value=p;try{const i=await se({query:me(p)});y.value=i.data.results,u.value=i.data.count}catch(i){f.error(s("TokensView.loadFailure")),console.error(i)}finally{k.value=!1}}const a=pe(D,250);function r(p){d.onOptionsUpdate(p),a(p)}async function T(p){const i=s("TokensView.confirmDelete",{tokenKey:p.token_key});if(await v.value.confirm(i))try{await ne({path:{digest:p.pk}}),h(),f.success(s("TokensView.deleteSuccess"))}catch(A){f.error(re(A,s("TokensView.deleteFailure"))),console.error(A)}}function j(p){x.value=p,w.value=!0,h()}return(p,i)=>(C(),V(ie,{breadcrumbs:m},{default:o(()=>[n(M,null,{default:o(()=>[n(O,null,{default:o(()=>[e(t).canAdd(e(K).AUTH_TOKEN)?(C(),V(F,{key:0,color:"primary",class:"mb-4",onClick:i[0]||(i[0]=l=>_.value=!0)},{prepend:o(()=>[n(e(U),{icon:e(te)},null,8,["icon"])]),default:o(()=>[R(" "+S(e(s)("TokensView.newToken")),1)]),_:1})):P("",!0)]),_:1})]),_:1}),n(M,null,{default:o(()=>[n(O,null,{default:o(()=>[n(ke,{"items-per-page":e(d).perPage.value,"onUpdate:itemsPerPage":i[1]||(i[1]=l=>e(d).perPage.value=l),"sort-by":e(d).sortByArray.value,class:"elevation-1 primary","item-value":"pk",density:"compact",headers:$,items:y.value,"items-length":u.value,loading:k.value,page:e(d).page.value,"items-per-page-options":e(d).pageSizeOptions,"no-data-text":e(s)("TokensView.noTokensFound"),"loading-text":e(s)("TokensView.loadingTokens"),"onUpdate:options":r},{"item.token_key":o(({item:l})=>[z("code",null,S(l.token_key)+"...",1)]),"item.created":o(({item:l})=>[n(L,{value:l.created},null,8,["value"])]),"item.expiry":o(({item:l})=>[n(L,{value:l.expiry},null,8,["value"])]),"item.actions":o(({item:l})=>[e(t).canDelete(e(K).AUTH_TOKEN)?(C(),V(F,{key:0,variant:"text",color:"error",size:"small",onClick:A=>T(l)},{default:o(()=>[n(e(U),{icon:e(ae)},null,8,["icon"])]),_:1},8,["onClick"])):P("",!0)]),_:1},8,["items-per-page","sort-by","items","items-length","loading","page","items-per-page-options","no-data-text","loading-text"])]),_:1})]),_:1}),n(ge,{visible:_.value,"onUpdate:visible":i[2]||(i[2]=l=>_.value=l),onCreated:j},null,8,["visible"]),n(ye,{visible:w.value,"onUpdate:visible":i[3]||(i[3]=l=>w.value=l),token:x.value},null,8,["visible","token"])]),_:1}))}});export{Ue as default};
//# sourceMappingURL=TokensView-BpQqTfKX.js.map
