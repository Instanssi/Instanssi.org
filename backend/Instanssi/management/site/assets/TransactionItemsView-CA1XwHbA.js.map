{"version":3,"file":"TransactionItemsView-CA1XwHbA.js","sources":["../../../../../admin/src/views/store/TransactionItemsView.vue"],"sourcesContent":["<template>\n    <LayoutBase :key=\"`transaction-items-${eventId}`\" :breadcrumbs=\"breadcrumbs\">\n        <v-col>\n            <v-row>\n                <ExportButton\n                    :label=\"t('TransactionItemsView.export')\"\n                    :loading=\"exportLoading\"\n                    @export=\"exportData\"\n                />\n                <v-select\n                    v-model=\"selectedItem\"\n                    :items=\"itemOptions\"\n                    variant=\"outlined\"\n                    density=\"compact\"\n                    :label=\"t('TransactionItemsView.filterByItem')\"\n                    style=\"max-width: 300px\"\n                    class=\"ma-0 pa-0 ml-4\"\n                    clearable\n                />\n                <v-text-field\n                    v-model=\"search\"\n                    variant=\"outlined\"\n                    density=\"compact\"\n                    :label=\"t('General.search')\"\n                    style=\"max-width: 400px\"\n                    class=\"ma-0 pa-0 ml-4\"\n                    clearable\n                />\n            </v-row>\n        </v-col>\n        <v-col>\n            <v-row>\n                <v-data-table-server\n                    v-model:items-per-page=\"perPage\"\n                    class=\"elevation-1 primary\"\n                    item-value=\"id\"\n                    density=\"compact\"\n                    :headers=\"headers\"\n                    :items=\"items\"\n                    :items-length=\"totalItems\"\n                    :loading=\"loading\"\n                    :search=\"search\"\n                    :page=\"currentPage\"\n                    :items-per-page-options=\"pageSizeOptions\"\n                    :no-data-text=\"t('TransactionItemsView.noItemsFound')\"\n                    :loading-text=\"t('TransactionItemsView.loadingItems')\"\n                    @update:options=\"debouncedLoad\"\n                >\n                    <template #item.item=\"{ item }\">\n                        {{ getItemName(item.item) }}\n                    </template>\n                    <template #item.variant=\"{ item }\">\n                        {{ getVariantName(item.item, item.variant) }}\n                    </template>\n                    <template #item.purchase_price=\"{ item }\">\n                        <PriceCell :value=\"item.purchase_price\" />\n                    </template>\n                    <template #item.is_delivered=\"{ item }\">\n                        <BooleanIcon :value=\"item.is_delivered\" />\n                    </template>\n                </v-data-table-server>\n            </v-row>\n        </v-col>\n    </LayoutBase>\n</template>\n\n<script setup lang=\"ts\">\nimport { debounce, parseInt } from \"lodash-es\";\nimport { type Ref, computed, onMounted, ref, watch } from \"vue\";\nimport { useI18n } from \"vue-i18n\";\nimport { useToast } from \"vue-toastification\";\nimport type { VDataTable } from \"vuetify/components\";\n\nimport * as api from \"@/api\";\nimport type { TransactionItem, StoreItem, StoreTransaction } from \"@/api\";\nimport BooleanIcon from \"@/components/table/BooleanIcon.vue\";\nimport ExportButton from \"@/components/form/ExportButton.vue\";\nimport LayoutBase, { type BreadcrumbItem } from \"@/components/layout/LayoutBase.vue\";\nimport PriceCell from \"@/components/table/PriceCell.vue\";\nimport { useEvents } from \"@/services/events\";\nimport { type LoadArgs, getLoadArgs } from \"@/services/utils/query_tools\";\nimport { downloadSpreadsheet, type SpreadsheetFormat } from \"@/utils/spreadsheet\";\n\ntype ReadonlyHeaders = VDataTable[\"$props\"][\"headers\"];\n\nconst props = defineProps<{ eventId: string }>();\nconst { t } = useI18n();\nconst toast = useToast();\nconst { getEventById } = useEvents();\nconst eventId = computed(() => parseInt(props.eventId, 10));\nconst loading = ref(false);\nconst exportLoading = ref(false);\n\nconst breadcrumbs = computed<BreadcrumbItem[]>(() => [\n    {\n        title: getEventById(eventId.value)?.name ?? \"...\",\n        to: { name: \"dashboard\", params: { eventId: props.eventId } },\n    },\n    { title: t(\"TransactionItemsView.title\"), disabled: true },\n]);\nconst pageSizeOptions = [25, 50, 100];\nconst perPage = ref(pageSizeOptions[0]);\nconst totalItems = ref(0);\nconst currentPage = ref(1);\nconst items: Ref<TransactionItem[]> = ref([]);\nconst storeItems: Ref<StoreItem[]> = ref([]);\nconst search = ref(\"\");\nconst selectedItem: Ref<number | null> = ref(null);\nconst lastLoadArgs: Ref<LoadArgs | null> = ref(null);\n\nconst headers: ReadonlyHeaders = [\n    {\n        title: t(\"TransactionItemsView.headers.id\"),\n        sortable: true,\n        key: \"id\",\n    },\n    {\n        title: t(\"TransactionItemsView.headers.transactionId\"),\n        sortable: true,\n        key: \"transaction\",\n    },\n    {\n        title: t(\"TransactionItemsView.headers.item\"),\n        sortable: false,\n        key: \"item\",\n    },\n    {\n        title: t(\"TransactionItemsView.headers.variant\"),\n        sortable: false,\n        key: \"variant\",\n    },\n    {\n        title: t(\"TransactionItemsView.headers.price\"),\n        sortable: true,\n        key: \"purchase_price\",\n    },\n    {\n        title: t(\"TransactionItemsView.headers.key\"),\n        sortable: false,\n        key: \"key\",\n    },\n    {\n        title: t(\"TransactionItemsView.headers.delivered\"),\n        sortable: false,\n        key: \"is_delivered\",\n    },\n];\n\nconst itemOptions = computed(() => [\n    { title: t(\"TransactionItemsView.allItems\"), value: null },\n    ...storeItems.value.map((item) => ({ title: item.name, value: item.id })),\n]);\n\nfunction getItemName(itemId: number): string {\n    const item = storeItems.value.find((i) => i.id === itemId);\n    return item?.name ?? `#${itemId}`;\n}\n\nfunction getVariantName(itemId: number, variantId: number | null | undefined): string {\n    if (!variantId) return \"-\";\n    const item = storeItems.value.find((i) => i.id === itemId);\n    if (!item) return `#${variantId}`;\n    const variant = item.variants?.find((v) => v.id === variantId);\n    return variant?.name ?? `#${variantId}`;\n}\n\nasync function loadStoreItems() {\n    try {\n        const response = await api.adminEventStoreItemsList({\n            path: { event_pk: eventId.value },\n            query: { limit: 1000 },\n        });\n        storeItems.value = response.data!.results;\n    } catch (e) {\n        console.error(\"Failed to load store items:\", e);\n    }\n}\n\nasync function load(args: LoadArgs) {\n    loading.value = true;\n    lastLoadArgs.value = args;\n    try {\n        const response = await api.adminEventStoreTransactionItemsList({\n            path: { event_pk: eventId.value },\n            query: {\n                ...getLoadArgs(args),\n                ...(selectedItem.value ? { item: selectedItem.value } : {}),\n            },\n        });\n        items.value = response.data!.results;\n        totalItems.value = response.data!.count;\n    } catch (e) {\n        toast.error(t(\"TransactionItemsView.loadFailure\"));\n        console.error(e);\n    } finally {\n        loading.value = false;\n    }\n}\n\nconst debouncedLoad = debounce(load, 250);\n\n// Reload when item filter changes\nwatch(selectedItem, () => {\n    if (lastLoadArgs.value) {\n        debouncedLoad(lastLoadArgs.value);\n    }\n});\n\nasync function exportData(format: SpreadsheetFormat): Promise<void> {\n    exportLoading.value = true;\n    try {\n        // Fetch all data for export\n        const [itemsResponse, transactionsResponse, txItemsResponse] = await Promise.all([\n            api.adminEventStoreItemsList({\n                path: { event_pk: eventId.value },\n                query: { limit: 1000 },\n            }),\n            api.adminEventStoreTransactionsList({\n                path: { event_pk: eventId.value },\n                query: { limit: 10000 },\n            }),\n            api.adminEventStoreTransactionItemsList({\n                path: { event_pk: eventId.value },\n                query: { limit: 10000 },\n            }),\n        ]);\n\n        const allStoreItems = itemsResponse.data!.results;\n        const transactions = transactionsResponse.data!.results;\n        const txItems = txItemsResponse.data!.results;\n\n        // Build transaction lookup map\n        const transactionMap = new Map<number, StoreTransaction>();\n        for (const tx of transactions) {\n            transactionMap.set(tx.id, tx);\n        }\n\n        // Helper to get item/variant names\n        const getExportItemName = (itemId: number): string => {\n            const item = allStoreItems.find((i) => i.id === itemId);\n            return item?.name ?? `#${itemId}`;\n        };\n        const getExportVariantName = (\n            itemId: number,\n            variantId: number | null | undefined\n        ): string => {\n            if (!variantId) return \"\";\n            const item = allStoreItems.find((i) => i.id === itemId);\n            if (!item) return `#${variantId}`;\n            const variant = item.variants?.find((v) => v.id === variantId);\n            return variant?.name ?? `#${variantId}`;\n        };\n\n        // Build export data with headers\n        const data: Array<Array<string | number>> = [\n            [\n                \"Item ID\",\n                \"Product\",\n                \"Variant\",\n                \"Purchase Price\",\n                \"Original Price\",\n                \"Delivered\",\n                \"Delivery Time\",\n                \"Transaction ID\",\n                \"First Name\",\n                \"Last Name\",\n                \"Company\",\n                \"Email\",\n                \"Telephone\",\n                \"Mobile\",\n                \"Street\",\n                \"Postal Code\",\n                \"City\",\n                \"Country\",\n                \"Status\",\n                \"Created\",\n                \"Paid\",\n                \"Total Price\",\n            ],\n        ];\n\n        for (const txItem of txItems) {\n            const tx = transactionMap.get(txItem.transaction);\n            const status = tx?.is_paid\n                ? \"Paid\"\n                : tx?.is_cancelled\n                  ? \"Cancelled\"\n                  : tx?.is_pending\n                    ? \"Pending\"\n                    : \"Created\";\n\n            data.push([\n                txItem.id,\n                getExportItemName(txItem.item),\n                getExportVariantName(txItem.item, txItem.variant),\n                txItem.purchase_price,\n                txItem.original_price,\n                txItem.is_delivered ? \"Yes\" : \"No\",\n                txItem.time_delivered ?? \"\",\n                tx?.id ?? \"\",\n                tx?.firstname ?? \"\",\n                tx?.lastname ?? \"\",\n                tx?.company ?? \"\",\n                tx?.email ?? \"\",\n                tx?.telephone ?? \"\",\n                tx?.mobile ?? \"\",\n                tx?.street ?? \"\",\n                tx?.postalcode ?? \"\",\n                tx?.city ?? \"\",\n                tx?.country ?? \"\",\n                status,\n                tx?.time_created ?? \"\",\n                tx?.time_paid ?? \"\",\n                tx?.total_price ?? \"\",\n            ]);\n        }\n\n        downloadSpreadsheet(data, \"instanssi_transaction_items\", format, \"Transaction Items\");\n        toast.success(t(\"TransactionItemsView.exportSuccess\"));\n    } catch (e) {\n        toast.error(t(\"TransactionItemsView.exportFailure\"));\n        console.error(e);\n    } finally {\n        exportLoading.value = false;\n    }\n}\n\nonMounted(() => {\n    loadStoreItems();\n});\n</script>\n"],"names":["props","__props","t","useI18n","toast","useToast","getEventById","useEvents","eventId","computed","parseInt","loading","ref","exportLoading","breadcrumbs","pageSizeOptions","perPage","totalItems","currentPage","items","storeItems","search","selectedItem","lastLoadArgs","headers","itemOptions","item","getItemName","itemId","i","getVariantName","variantId","v","loadStoreItems","response","api.adminEventStoreItemsList","e","load","args","api.adminEventStoreTransactionItemsList","getLoadArgs","debouncedLoad","debounce","watch","exportData","format","itemsResponse","transactionsResponse","txItemsResponse","api.adminEventStoreTransactionsList","allStoreItems","transactions","txItems","transactionMap","tx","getExportItemName","getExportVariantName","data","txItem","status","downloadSpreadsheet","onMounted","_createBlock","LayoutBase","_createVNode","_component_v_col","_component_v_row","ExportButton","_unref","_component_v_select","$event","_component_v_text_field","_component_v_data_table_server","_withCtx","_createTextVNode","_toDisplayString","PriceCell","BooleanIcon"],"mappings":"syBAqFA,MAAMA,EAAQC,EACR,CAAE,EAAAC,CAAA,EAAMC,EAAA,EACRC,EAAQC,GAAA,EACR,CAAE,aAAAC,CAAA,EAAiBC,GAAA,EACnBC,EAAUC,EAAS,IAAMC,GAASV,EAAM,QAAS,EAAE,CAAC,EACpDW,EAAUC,EAAI,EAAK,EACnBC,EAAgBD,EAAI,EAAK,EAEzBE,EAAcL,EAA2B,IAAM,CACjD,CACI,MAAOH,EAAaE,EAAQ,KAAK,GAAG,MAAQ,MAC5C,GAAI,CAAE,KAAM,YAAa,OAAQ,CAAE,QAASR,EAAM,OAAA,CAAQ,CAAE,EAEhE,CAAE,MAAOE,EAAE,4BAA4B,EAAG,SAAU,EAAA,CAAK,CAC5D,EACKa,EAAkB,CAAC,GAAI,GAAI,GAAG,EAC9BC,EAAUJ,EAAIG,EAAgB,CAAC,CAAC,EAChCE,EAAaL,EAAI,CAAC,EAClBM,EAAcN,EAAI,CAAC,EACnBO,EAAgCP,EAAI,EAAE,EACtCQ,EAA+BR,EAAI,EAAE,EACrCS,EAAST,EAAI,EAAE,EACfU,EAAmCV,EAAI,IAAI,EAC3CW,EAAqCX,EAAI,IAAI,EAE7CY,EAA2B,CAC7B,CACI,MAAOtB,EAAE,iCAAiC,EAC1C,SAAU,GACV,IAAK,IAAA,EAET,CACI,MAAOA,EAAE,4CAA4C,EACrD,SAAU,GACV,IAAK,aAAA,EAET,CACI,MAAOA,EAAE,mCAAmC,EAC5C,SAAU,GACV,IAAK,MAAA,EAET,CACI,MAAOA,EAAE,sCAAsC,EAC/C,SAAU,GACV,IAAK,SAAA,EAET,CACI,MAAOA,EAAE,oCAAoC,EAC7C,SAAU,GACV,IAAK,gBAAA,EAET,CACI,MAAOA,EAAE,kCAAkC,EAC3C,SAAU,GACV,IAAK,KAAA,EAET,CACI,MAAOA,EAAE,wCAAwC,EACjD,SAAU,GACV,IAAK,cAAA,CACT,EAGEuB,EAAchB,EAAS,IAAM,CAC/B,CAAE,MAAOP,EAAE,+BAA+B,EAAG,MAAO,IAAA,EACpD,GAAGkB,EAAW,MAAM,IAAKM,IAAU,CAAE,MAAOA,EAAK,KAAM,MAAOA,EAAK,IAAK,CAAA,CAC3E,EAED,SAASC,EAAYC,EAAwB,CAEzC,OADaR,EAAW,MAAM,KAAMS,GAAMA,EAAE,KAAOD,CAAM,GAC5C,MAAQ,IAAIA,CAAM,EACnC,CAEA,SAASE,EAAeF,EAAgBG,EAA8C,CAClF,GAAI,CAACA,EAAW,MAAO,IACvB,MAAML,EAAON,EAAW,MAAM,KAAMS,GAAMA,EAAE,KAAOD,CAAM,EACzD,OAAKF,EACWA,EAAK,UAAU,KAAMM,GAAMA,EAAE,KAAOD,CAAS,GAC7C,MAAQ,IAAIA,CAAS,GAFnB,IAAIA,CAAS,EAGnC,CAEA,eAAeE,GAAiB,CAC5B,GAAI,CACA,MAAMC,EAAW,MAAMC,EAA6B,CAChD,KAAM,CAAE,SAAU3B,EAAQ,KAAA,EAC1B,MAAO,CAAE,MAAO,GAAA,CAAK,CACxB,EACDY,EAAW,MAAQc,EAAS,KAAM,OACtC,OAASE,EAAG,CACR,QAAQ,MAAM,8BAA+BA,CAAC,CAClD,CACJ,CAEA,eAAeC,EAAKC,EAAgB,CAChC3B,EAAQ,MAAQ,GAChBY,EAAa,MAAQe,EACrB,GAAI,CACA,MAAMJ,EAAW,MAAMK,EAAwC,CAC3D,KAAM,CAAE,SAAU/B,EAAQ,KAAA,EAC1B,MAAO,CACH,GAAGgC,GAAYF,CAAI,EACnB,GAAIhB,EAAa,MAAQ,CAAE,KAAMA,EAAa,KAAA,EAAU,CAAA,CAAC,CAC7D,CACH,EACDH,EAAM,MAAQe,EAAS,KAAM,QAC7BjB,EAAW,MAAQiB,EAAS,KAAM,KACtC,OAASE,EAAG,CACRhC,EAAM,MAAMF,EAAE,kCAAkC,CAAC,EACjD,QAAQ,MAAMkC,CAAC,CACnB,QAAA,CACIzB,EAAQ,MAAQ,EACpB,CACJ,CAEA,MAAM8B,EAAgBC,GAASL,EAAM,GAAG,EAGxCM,GAAMrB,EAAc,IAAM,CAClBC,EAAa,OACbkB,EAAclB,EAAa,KAAK,CAExC,CAAC,EAED,eAAeqB,EAAWC,EAA0C,CAChEhC,EAAc,MAAQ,GACtB,GAAI,CAEA,KAAM,CAACiC,EAAeC,EAAsBC,CAAe,EAAI,MAAM,QAAQ,IAAI,CAC7Eb,EAA6B,CACzB,KAAM,CAAE,SAAU3B,EAAQ,KAAA,EAC1B,MAAO,CAAE,MAAO,GAAA,CAAK,CACxB,EACDyC,GAAoC,CAChC,KAAM,CAAE,SAAUzC,EAAQ,KAAA,EAC1B,MAAO,CAAE,MAAO,GAAA,CAAM,CACzB,EACD+B,EAAwC,CACpC,KAAM,CAAE,SAAU/B,EAAQ,KAAA,EAC1B,MAAO,CAAE,MAAO,GAAA,CAAM,CACzB,CAAA,CACJ,EAEK0C,EAAgBJ,EAAc,KAAM,QACpCK,EAAeJ,EAAqB,KAAM,QAC1CK,EAAUJ,EAAgB,KAAM,QAGhCK,MAAqB,IAC3B,UAAWC,KAAMH,EACbE,EAAe,IAAIC,EAAG,GAAIA,CAAE,EAIhC,MAAMC,EAAqB3B,GACVsB,EAAc,KAAMrB,GAAMA,EAAE,KAAOD,CAAM,GACzC,MAAQ,IAAIA,CAAM,GAE7B4B,EAAuB,CACzB5B,EACAG,IACS,CACT,GAAI,CAACA,EAAW,MAAO,GACvB,MAAML,EAAOwB,EAAc,KAAMrB,GAAMA,EAAE,KAAOD,CAAM,EACtD,OAAKF,EACWA,EAAK,UAAU,KAAMM,GAAMA,EAAE,KAAOD,CAAS,GAC7C,MAAQ,IAAIA,CAAS,GAFnB,IAAIA,CAAS,EAGnC,EAGM0B,EAAsC,CACxC,CACI,UACA,UACA,UACA,iBACA,iBACA,YACA,gBACA,iBACA,aACA,YACA,UACA,QACA,YACA,SACA,SACA,cACA,OACA,UACA,SACA,UACA,OACA,aAAA,CACJ,EAGJ,UAAWC,KAAUN,EAAS,CAC1B,MAAME,EAAKD,EAAe,IAAIK,EAAO,WAAW,EAC1CC,EAASL,GAAI,QACb,OACAA,GAAI,aACF,YACAA,GAAI,WACF,UACA,UAEVG,EAAK,KAAK,CACNC,EAAO,GACPH,EAAkBG,EAAO,IAAI,EAC7BF,EAAqBE,EAAO,KAAMA,EAAO,OAAO,EAChDA,EAAO,eACPA,EAAO,eACPA,EAAO,aAAe,MAAQ,KAC9BA,EAAO,gBAAkB,GACzBJ,GAAI,IAAM,GACVA,GAAI,WAAa,GACjBA,GAAI,UAAY,GAChBA,GAAI,SAAW,GACfA,GAAI,OAAS,GACbA,GAAI,WAAa,GACjBA,GAAI,QAAU,GACdA,GAAI,QAAU,GACdA,GAAI,YAAc,GAClBA,GAAI,MAAQ,GACZA,GAAI,SAAW,GACfK,EACAL,GAAI,cAAgB,GACpBA,GAAI,WAAa,GACjBA,GAAI,aAAe,EAAA,CACtB,CACL,CAEAM,GAAoBH,EAAM,8BAA+BZ,EAAQ,mBAAmB,EACpFzC,EAAM,QAAQF,EAAE,oCAAoC,CAAC,CACzD,OAASkC,EAAG,CACRhC,EAAM,MAAMF,EAAE,oCAAoC,CAAC,EACnD,QAAQ,MAAMkC,CAAC,CACnB,QAAA,CACIvB,EAAc,MAAQ,EAC1B,CACJ,CAEA,OAAAgD,GAAU,IAAM,CACZ5B,EAAA,CACJ,CAAC,eAxUG6B,GA8DaC,GAAA,CA9DA,yBAA0BvD,EAAA,KAAO,GAAK,YAAaM,EAAA,KAAA,aAC5D,IA2BQ,CA3BRkD,EA2BQC,EAAA,KAAA,WA1BJ,IAyBQ,CAzBRD,EAyBQE,EAAA,KAAA,WAxBJ,IAIE,CAJFF,EAIEG,GAAA,CAHG,MAAOC,EAAAlE,CAAA,EAAC,6BAAA,EACR,QAASW,EAAA,MACT,SAAQ+B,CAAA,8BAEboB,EASEK,GAAA,YARW/C,EAAA,2CAAAA,EAAY,MAAAgD,GACpB,MAAO7C,EAAA,MACR,QAAQ,WACR,QAAQ,UACP,MAAO2C,EAAAlE,CAAA,EAAC,mCAAA,EACT,MAAA,CAAA,YAAA,OAAA,EACA,MAAM,iBACN,UAAA,EAAA,yCAEJ8D,EAQEO,GAAA,YAPWlD,EAAA,2CAAAA,EAAM,MAAAiD,GACf,QAAQ,WACR,QAAQ,UACP,MAAOF,EAAAlE,CAAA,EAAC,gBAAA,EACT,MAAA,CAAA,YAAA,OAAA,EACA,MAAM,iBACN,UAAA,EAAA,iDAIZ8D,EAgCQC,EAAA,KAAA,WA/BJ,IA8BQ,CA9BRD,EA8BQE,EAAA,KAAA,WA7BJ,IA4BsB,CA5BtBF,EA4BsBQ,GAAA,CA3BV,iBAAgBxD,EAAA,6CAAAA,EAAO,MAAAsD,GAC/B,MAAM,sBACN,aAAW,KACX,QAAQ,UACP,QAAA9C,EACA,MAAOL,EAAA,MACP,eAAcF,EAAA,MACd,QAASN,EAAA,MACT,OAAQU,EAAA,MACR,KAAMH,EAAA,MACN,yBAAwBH,EACxB,eAAcqD,EAAAlE,CAAA,EAAC,mCAAA,EACf,eAAckE,EAAAlE,CAAA,EAAC,mCAAA,EACf,mBAAgBkE,EAAA3B,CAAA,CAAA,GAEN,YAASgC,EAChB,CAA4B,CADR,KAAA/C,KAAI,KACrBC,EAAYD,EAAK,IAAI,CAAA,EAAA,CAAA,CAAA,GAEjB,eAAY+C,EACnB,CAA6C,CADtB,KAAA/C,KAAI,CACxBgD,EAAAC,EAAA7C,EAAeJ,EAAK,KAAMA,EAAK,OAAO,CAAA,EAAA,CAAA,CAAA,GAElC,sBAAmB+C,EAC1B,CAA0C,CADZ,KAAA/C,KAAI,CAClCsC,EAA0CY,GAAA,CAA9B,MAAOlD,EAAK,cAAA,sBAEjB,oBAAiB+C,EACxB,CAA0C,CADd,KAAA/C,KAAI,CAChCsC,EAA0Ca,GAAA,CAA5B,MAAOnD,EAAK,YAAA"}