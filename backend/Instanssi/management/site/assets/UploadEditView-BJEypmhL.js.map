{"version":3,"file":"UploadEditView-BJEypmhL.js","sources":["../../../../../admin/src/views/uploads/UploadEditView.vue"],"sourcesContent":["<template>\n    <LayoutBase :breadcrumbs=\"breadcrumbs\">\n        <v-col v-if=\"loading\" class=\"d-flex justify-center my-8\">\n            <v-progress-circular indeterminate size=\"64\" />\n        </v-col>\n        <v-col v-else>\n            <v-card>\n                <v-card-text>\n                    <v-form @submit.prevent=\"submit\">\n                        <FileUploadField\n                            v-model=\"file.value.value\"\n                            :current-file-url=\"currentFileUrl\"\n                            :label=\"t('UploadEditView.labels.file')\"\n                            :error-message=\"file.errorMessage.value\"\n                            :required=\"!isEditMode\"\n                        />\n                        <v-textarea\n                            v-model=\"description.value.value\"\n                            :error-messages=\"description.errorMessage.value\"\n                            variant=\"outlined\"\n                            :label=\"t('UploadEditView.labels.description')\"\n                            rows=\"3\"\n                        />\n                    </v-form>\n                </v-card-text>\n                <v-card-actions class=\"justify-end\">\n                    <AuditLogButton\n                        v-if=\"isEditMode\"\n                        app-label=\"admin_upload\"\n                        model=\"uploadedfile\"\n                        :object-pk=\"props.id\"\n                    />\n                    <v-spacer />\n                    <v-btn variant=\"text\" @click=\"goBack\">\n                        {{ t(\"General.cancel\") }}\n                    </v-btn>\n                    <v-btn\n                        variant=\"elevated\"\n                        color=\"primary\"\n                        :loading=\"saving\"\n                        :disabled=\"!meta.valid\"\n                        @click=\"submit\"\n                    >\n                        <template #prepend>\n                            <FontAwesomeIcon :icon=\"faSave\" />\n                        </template>\n                        {{ t(\"General.save\") }}\n                    </v-btn>\n                </v-card-actions>\n            </v-card>\n        </v-col>\n    </LayoutBase>\n</template>\n\n<script setup lang=\"ts\">\nimport { faFloppyDisk as faSave } from \"@fortawesome/free-solid-svg-icons\";\nimport { FontAwesomeIcon } from \"@fortawesome/vue-fontawesome\";\nimport { parseInt } from \"lodash-es\";\nimport { type GenericObject, useField, useForm } from \"vee-validate\";\nimport { computed, onMounted, ref } from \"vue\";\nimport { useI18n } from \"vue-i18n\";\nimport { useRouter } from \"vue-router\";\nimport { useToast } from \"vue-toastification\";\nimport { mixed as yupMixed, object as yupObject, string as yupString } from \"yup\";\n\nimport * as api from \"@/api\";\nimport AuditLogButton from \"@/components/auditlog/AuditLogButton.vue\";\nimport FileUploadField from \"@/components/form/FileUploadField.vue\";\nimport LayoutBase, { type BreadcrumbItem } from \"@/components/layout/LayoutBase.vue\";\nimport { useEvents } from \"@/services/events\";\nimport { type FileValue, getFile } from \"@/utils/file\";\nimport { prepareFileField, toFormData } from \"@/utils/formdata\";\nimport { handleApiError, type FieldMapping } from \"@/utils/http\";\n\n/** Maps API field names (snake_case) to form field names (camelCase) */\nconst API_FIELD_MAPPING: FieldMapping = {\n    description: \"description\",\n    file: \"file\",\n};\n\nconst props = defineProps<{\n    eventId: string;\n    id?: string;\n}>();\n\nconst { t } = useI18n();\nconst router = useRouter();\nconst toast = useToast();\nconst { getEventById } = useEvents();\n\nconst loading = ref(false);\nconst saving = ref(false);\nconst itemDescription = ref<string>(\"\");\nconst eventId = computed(() => parseInt(props.eventId, 10));\nconst isEditMode = computed(() => props.id !== undefined);\nconst currentFileUrl = ref<string | null>(null);\n\nconst breadcrumbs = computed<BreadcrumbItem[]>(() => {\n    const items: BreadcrumbItem[] = [\n        {\n            title: getEventById(eventId.value)?.name ?? \"...\",\n            to: { name: \"dashboard\", params: { eventId: props.eventId } },\n        },\n        {\n            title: t(\"UploadsView.title\"),\n            to: { name: \"uploads\", params: { eventId: props.eventId } },\n        },\n    ];\n    if (isEditMode.value) {\n        items.push({ title: itemDescription.value || \"...\", disabled: true });\n    } else {\n        items.push({ title: t(\"Breadcrumbs.newUpload\"), disabled: true });\n    }\n    return items;\n});\n\n// Form validation\nconst validationSchema = yupObject({\n    description: yupString().max(255),\n    file: yupMixed()\n        .nullable()\n        .test(\"file-required\", t(\"UploadEditView.fileRequired\"), (value) => {\n            // File is required for create mode only\n            if (currentFileUrl.value) return true; // Existing file in edit mode\n            return !!getFile(value as FileValue);\n        }),\n});\n\nconst { handleSubmit, setValues, setErrors, meta } = useForm({\n    validationSchema,\n    initialValues: {\n        description: \"\",\n        file: undefined as FileValue | undefined,\n    },\n});\n\nconst description = useField<string>(\"description\");\nconst file = useField<FileValue>(\"file\");\n\nfunction getFilename(url: string): string {\n    try {\n        const pathname = new URL(url).pathname;\n        return pathname.split(\"/\").pop() || url;\n    } catch {\n        return url;\n    }\n}\n\nconst submit = handleSubmit(async (values) => {\n    saving.value = true;\n    let ok: boolean;\n    if (isEditMode.value) {\n        ok = await editItem(parseInt(props.id!, 10), values);\n    } else {\n        ok = await createItem(values);\n    }\n    saving.value = false;\n    if (ok) {\n        goBack();\n    }\n});\n\nfunction buildBody(values: GenericObject, isCreate: boolean) {\n    const fileGetter = isCreate ? getFile : prepareFileField;\n    return {\n        description: values.description || \"\",\n        file: fileGetter(values.file),\n    };\n}\n\nasync function createItem(values: GenericObject) {\n    const body = buildBody(values, true);\n    if (!body.file) {\n        return false;\n    }\n    try {\n        await api.adminEventUploadsFilesCreate({\n            path: { event_pk: eventId.value },\n            body: body as typeof body & { file: File },\n            bodySerializer: () => toFormData(body),\n        });\n        toast.success(t(\"UploadEditView.createSuccess\"));\n        return true;\n    } catch (e) {\n        handleApiError(e, setErrors, toast, t(\"UploadEditView.createFailure\"), API_FIELD_MAPPING);\n    }\n    return false;\n}\n\nasync function editItem(itemId: number, values: GenericObject) {\n    const body = buildBody(values, false);\n    try {\n        await api.adminEventUploadsFilesPartialUpdate({\n            path: { event_pk: eventId.value, id: itemId },\n            // Type assertion needed: our bodySerializer handles null for file clearing\n            body: body as api.PatchedUploadedFileRequest,\n            bodySerializer: () => toFormData(body),\n        });\n        toast.success(t(\"UploadEditView.editSuccess\"));\n        return true;\n    } catch (e) {\n        handleApiError(e, setErrors, toast, t(\"UploadEditView.editFailure\"), API_FIELD_MAPPING);\n    }\n    return false;\n}\n\nfunction goBack() {\n    router.push({ name: \"uploads\", params: { eventId: props.eventId } });\n}\n\nonMounted(async () => {\n    if (isEditMode.value) {\n        loading.value = true;\n        try {\n            const response = await api.adminEventUploadsFilesRetrieve({\n                path: { event_pk: eventId.value, id: parseInt(props.id!, 10) },\n            });\n            const item = response.data!;\n            itemDescription.value = item.description || getFilename(item.file);\n            currentFileUrl.value = item.file;\n            setValues({\n                description: item.description ?? \"\",\n            });\n        } catch (e) {\n            toast.error(t(\"UploadEditView.loadFailure\"));\n            console.error(e);\n            goBack();\n        } finally {\n            loading.value = false;\n        }\n    }\n});\n</script>\n"],"names":["API_FIELD_MAPPING","props","__props","t","useI18n","router","useRouter","toast","useToast","getEventById","useEvents","loading","ref","saving","itemDescription","eventId","computed","parseInt","isEditMode","currentFileUrl","breadcrumbs","items","validationSchema","yupObject","yupString","yupMixed","value","getFile","handleSubmit","setValues","setErrors","meta","useForm","description","useField","file","getFilename","url","submit","values","ok","editItem","createItem","goBack","buildBody","isCreate","fileGetter","prepareFileField","body","api.adminEventUploadsFilesCreate","toFormData","e","handleApiError","itemId","api.adminEventUploadsFilesPartialUpdate","onMounted","item","api.adminEventUploadsFilesRetrieve","_createBlock","LayoutBase","_component_v_col","_createVNode","_component_v_progress_circular","_component_v_card","_component_v_card_text","_component_v_form","_unref","FileUploadField","$event","_component_v_textarea","_component_v_card_actions","AuditLogButton","_component_v_spacer","_component_v_btn","FontAwesomeIcon","faSave","_createTextVNode"],"mappings":"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"}