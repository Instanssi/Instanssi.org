(function(r){"use strict";function c(t,e,s){return new Promise((a,i)=>{let o=new XMLHttpRequest;o.onload=function(){if(o.status>=200&&o.status<300){let d=o.responseText;a(d&&d.length?JSON.parse(o.responseText):null)}else o.onerror()},o.onerror=function(){i(o.responseText?JSON.parse(o.responseText):null)},o.open(t,e),o.setRequestHeader("Accept","application/json"),o.setRequestHeader("Content-Type","application/json;charset=UTF-8"),o.send(s?JSON.stringify(s):null)})}let u=!!(typeof Intl=="object"&&Intl&&typeof Intl.NumberFormat=="function");function p(t){return t.toLocaleString("fi",{style:"currency",currency:"EUR"})}function f(t){return t.toFixed(2)+" €"}function v(t,...e){return u?p(t,...e):f(t,...e)}function l(t,e,s){return t.product.id===e.id&&(!s||t.variant&&s.id===t.variant.id)}function h(t,e){let s=t.discount_amount,a=(100-t.discount_percentage)/100,i=1;return s&&e>=s&&(i*=a),t.price*i}r.component("store-form-group",{props:{title:String,field:String,messages:Object,update:Function,data:Object,required:Boolean,autocomplete:String},methods:{onInput(t){this.$emit("update",this.field,t)}},computed:{clazz(){let{messages:t,field:e}=this,s=this.required?"form-group form-group-required":"form-group";return t&&t[e]&&t[e].length>0?s+" has-error":s}},template:`<div v-bind:class="clazz">
        <label class="col-sm-4 control-label">{{ title }}</label>
        <div class="col-sm-8">
            <input class="form-control"
                @input="onInput"
                :autocomplete="autocomplete"
                :id="'store-' + field"
                :value="data[field]"/>
            <store-messages :field="field" :messages="messages" />
        </div>
    </div>`}),r.component("store-messages",{props:{field:String,messages:Object},computed:{localMessages(){let{messages:t,field:e}=this;if(t&&t[e]&&t[e].length>0){let s=[];return t[e].forEach(a=>{if(typeof a=="string")s.push(a);else if(typeof a=="object"){let i=a.non_field_errors;typeof i=="object"&&i.length&&i.forEach(o=>{s.push(o)})}}),s}return null}},template:`<div v-show="localMessages"><p>
        <div class="alert alert-danger" role="alert" v-for="message in localMessages">
            <span class="fa fa-times"></span> {{ message }}
        </div>
    </p></div>`}),r.component("loading-overlay",{props:{loading:Boolean,text:String},computed:{clazz(){return this.loading?"loading-overlay loading-overlay-active":"loading-overlay"}},template:`<div v-bind:class="clazz">
        <div class="fa fa-spinner fa-pulse fa-3x fa-fw"></div>
        <div v-if="text">{{ text }}</div>
    </div>`});const g=`<form class="form-horizontal" @submit.prevent> <p>Huomaathan, että tuotteiden ja lippujen lunastukseen tarvittavat tiedot lähetetään annettuun sähköpostiosoitteeseen.</p> <div class="row"><div class="col-lg-6"> <store-form-group title="Etunimi" field="first_name" autocomplete="given-name" @update="update" :messages="messages" :data="data" :required="true" /> <store-form-group title="Sukunimi" field="last_name" autocomplete="family-name" @update="update" :messages="messages" :data="data" :required="true" /> <store-form-group title="Sähköposti" field="email" autocomplete="email" @update="update" :messages="messages" :data="data" :required="true" type="email" /> <store-form-group title="Vahvista sähköposti" autocomplete="email" field="email2" @update="update" :messages="messages" :data="data" :required="true" type="email" /> <store-form-group title="Matkapuhelin" field="mobile" autocomplete="tel" @update="update" :messages="messages" :data="data" type="tel" /> <store-form-group title="Muu puhelinnumero" field="telephone" autocomplete="off" @update="update" :messages="messages" :data="data" type="tel" /> </div> <div class="col-lg-6"> <store-form-group title="Katuosoite" field="street" autocomplete="billing street-address" @update="update" :messages="messages" :data="data" :required="true" /> <store-form-group title="Postinumero" field="postal_code" autocomplete="billing postal-code" @update="update" :messages="messages" :data="data" :required="true" /> <store-form-group title="Kaupunki" field="city" autocomplete="billing address-level2" @update="update" :messages="messages" :data="data" :required="true" /> <div class="form-group form-group-required"> <label class="col-sm-4 control-label">Maa</label> <div class="col-sm-8"> <select class="form-control" v-model="data.country"> <option value="fi">Suomi</option> </select> </div> </div> <store-form-group title="Yritys" field="company" @update="update" :messages="messages" :data="data" /> </div></div> <div class="form-group"> <label class="col-lg-2 control-label">Lisätietoja</label> <div class="col-lg-10"> <textarea id="store-information" class="form-control" @input="update('information', $event)" v-bind:value="data.information"></textarea> <store-messages field="information" :messages="messages" /> </div> </div> <div class="form-group required"> <div class="col-sm-12"> <label class="control-label"> <input id="store-read_terms" type="checkbox" v-model="data.read_terms" /> <span> Olen lukenut <a target="_blank" href="/store/terms">toimitusehdot</a> sekä <a target="_blank" href="/store/privacy">rekisteriselosteen</a> ja hyväksyn ne. </span> </label> <store-messages field="read_terms" :messages="messages" /> </div> </div> <div class="clearfix"></div> </form> `,b='<form class="form-horizontal store-summary" @submit.prevent> <div class="row"><div class="col-sm-12"> <store-summary-field title="Etunimi" field="first_name" :messages="messages" :data="data" /> <store-summary-field title="Sukunimi" field="last_name" :messages="messages" :data="data" /> <store-summary-field title="Sähköposti" field="email" :messages="messages" :data="data" /> <store-summary-field title="Matkapuhelin" field="mobile" :messages="messages" :data="data" /> <store-summary-field title="Muu puhelinnumero" field="telephone" :messages="messages" :data="data" /> </div> <div class="col-sm-12"> <store-summary-field title="Katuosoite" field="street" :messages="messages" :data="data" /> <store-summary-field title="Postinumero" field="postal_code" :messages="messages" :data="data" /> <store-summary-field title="Kaupunki" field="city" :messages="messages" :data="data" /> <store-summary-field title="Maa" field="country" :messages="messages" :data="data" /> <store-summary-field title="Yritys" field="company" :messages="messages" :data="data" /> </div></div> <div class="form-group" v-show="data.information && data.information.length"> <label class="col-sm-4 control-label">Lisätietoja</label> <div class="col-sm-8"> <p class="form-control-static">{{ data.information }}</p> <store-messages field="information" :messages="messages" /> </div> </div> <div class="clearfix"></div> </form> ';r.component("store-information-form",{template:g,props:{messages:Object,data:Object},methods:{update(t,e){this.data[t]=e.target.value,this.$emit("update")}}}),r.component("store-summary-field",{props:{title:String,field:String,messages:Object,data:Object},computed:{clazz(){let{messages:t,field:e}=this;return t&&t[e]&&t[e].length>0?"form-group has-error":"form-group"},hasData(){let{data:t,field:e}=this;return t[e]&&t[e].length>0}},template:`<div v-show="hasData" v-bind:class="clazz">
        <label class="col-sm-4 control-label">{{ title }}</label>
        <div class="col-sm-8">
            <p class="form-control-static">{{ data[field] }}</p>
            <store-messages :field="field" :messages="messages" />
        </div>
    </div>`}),r.component("store-order-summary",{template:b,props:{messages:Object,data:Object,cart:Array}}),r.component("store-cart-item",{template:'<div class="cart-item form-inline"> <div class="pull-left"> <img class="cart-item-image pull-left" :src="item.product.imagefile_thumbnail_url" /> <div class="cart-item-name form-control-static"> <span>{{ item.product.name }}</span> <span v-if="item.variant">({{ item.variant.name }})</span> </div> </div> <span class="pull-right"> <div class="pull-left form-control-static"> x <strong>{{ item.count }}</strong> = <strong>{{ getSubtotal(item) | formatPrice }}</strong> </div> <span class="pull-right" v-if="!readOnly"> <button class="btn btn-link" v-on:click="changeItemCount(item, 1)"> <span class="fa fa-plus fa-fw" /> </button> <button class="btn btn-link" v-on:click="changeItemCount(item, -1)"> <span class="fa fa-minus fa-fw" /> </button> <button class="btn btn-link" v-on:click="removeItemFromCart(item)"> <span class="fa fa-fw fa-trash"></span> </button> </span> </span> <span class="clearfix"></span> </div> ',props:{item:Object,readOnly:Boolean,changeItemCount:Function,removeItemFromCart:Function},methods:{getSubtotal(t){let e=1,s=t.product.discount_amount,a=(100-t.product.discount_percentage)/100;return s&&t.count>=s&&(e*=a),t.product.price*t.count*e}}}),r.component("store-product",{template:`<div v-bind:class="isDiscountActive() ? 'store-item form discount-enabled' : 'store-item form'"> <div class="row"> <div class="col-sm-9"> <div class="product-title"> <a class="product-thumbnail" @click.prevent="showFullSize" :href="product.imagefile_original_url" :data-title="product.name" data-toggle="lightbox" data-type="image" > <img class="item-image img-fluid" :src="product.imagefile_thumbnail_url" width="48" height="48" /> </a> <div class="item-title">{{ product.name }}</div> </div> <div class="item-description"> <div v-if="product.description" v-html="product.description"></div> <div v-if="product.discount_amount > 0" class="item-discount"> <strong>{{ product.discount_percentage }} %</strong> alennus, jos ostat ainakin <strong>{{ product.discount_amount }}</strong> kappaletta! </div> </div> </div> <div class="col-sm-3 form-inline"> <div class="item-price text-right">{{ effectivePrice | formatPrice }}</div> <div class="text-right"> <select class="form-control product-variants" v-if="product.variants && product.variants.length > 0" v-model="variant"> <option v-for="variant in product.variants" v-bind:value="variant"> {{ variant.name }} </option> </select> <button class="btn btn-success" :class="{ 'disabled': isOutOfStock }" v-on:click="addItem()"> <span class="fa fa-plus" /> Lisää </button> <div v-if="product.num_available < 1" class="text-danger product-availability-info"> Tuote lopussa. </div> <div v-else-if="isOutOfStock && product.num_available > 0" class="text-danger product-availability-info"> Vain {{ product.num_available}} kpl saatavilla. </div> </div> </div> </div> <div class="row" v-if="cartItems"> <div class="col-sm-12"> <store-cart-item v-for="item in cartItems" :item="item" :changeItemCount="changeItemCount" :removeItemFromCart="removeItemFromCart" /> </div> </div> </div>`,props:{product:Object,cart:Array,messages:Object,changeItemCount:Function,removeItemFromCart:Function},data(){return{variant:null}},created(){let t=this.product;t.variants&&t.variants.length&&(this.variant=t.variants[0])},methods:{addItem(){this.$emit("addItem",this.product,this.variant)},removeItem(){this.$emit("removeItem",this.product,this.variant)},getCartCount(){const{product:t,variant:e}=this;if(!this.cart)return 0;let s=this.cart.findIndex(a=>l(a,t,e));return s<0?0:this.cart[s].count},isDiscountActive(){const{product:t}=this;let e=t.discount_amount;return e>0&&this.getCartCount()>=e},getEffectivePrice(){return h(this.product,this.getCartCount())},showFullSize(){if(!this.product.imagefile_original_url)return;let t=$(this.$el).find(".product-thumbnail");$(t).ekkoLightbox()}},computed:{isOutOfStock(){return this.getCartCount()>=this.product.num_available},effectivePrice(){return this.getEffectivePrice()},cartItems(){let t=[];return this.cart.forEach(e=>{l(e,this.product)&&t.push(e)}),t}}});const y=`<div class="store"> <div class="store-nav"> <ul class="nav nav-pills"> <li role="presentation" :class="{ 'active': step === 0, 'disabled': !canMoveToStep(0) }"> <a href="#" @click.prevent="toStep(0, true)"> <span class="store-step-num">1.</span> <span class="store-step-title">Tuotteet</span> </a> </li> <li role="presentation" :class="{ 'active': step === 1, 'disabled': !canMoveToStep(1) }"> <a href="#" @click.prevent="canMoveToStep(1) && toStep(1, true)"> <span class="store-step-num">2.</span> <span class="store-step-title">Kori ja asiakastiedot</span> </a> </li> <li role="presentation" :class="{ 'active': step === 2, 'disabled': !canMoveToStep(2) }"> <a href="#" @click.prevent="canMoveToStep(2) && toStep(2, true)"> <span class="store-step-num">3.</span> <span class="store-step-title">Yhteenveto ja maksutapa</span> </a> </li> </ul> </div> <div v-if="step === 0" class="store-products"> <h3>Tuotteet</h3> <div class="list-unstyled store-items loading-container"> <store-product v-for="product in products" :product="product" :cart="cart" :messages="messages" :changeItemCount="changeItemCount" :removeItemFromCart="removeItemFromCart" @addItem="addItem" @removeItem="removeItem" /> <loading-overlay :loading="loadingStatus === 'loading'" /> <div v-if="loadingStatus === 'error'" class="alert alert-danger"> Virhe tuotelistaa hakiessa. </div> </div> <store-messages field="items" :messages="messages" /> <span class="pull-right"> <button class="btn btn-primary" @click="toStep(1, true)"> Ostoskori <span class="fa fa-shopping-cart"/> </button> </span> </div> <div v-if="step === 1" class="store-info"> <h3>Ostoskori</h3> <store-messages field="items" :messages="messages" /> <div class="list-unstyled store-items"> <store-cart-item v-for="item in cart" :item="item" :changeItemCount="changeItemCount" :removeItemFromCart="removeItemFromCart" /> <div class="pull-right cart-total"> Yhteensä: <strong>{{ totalPrice | formatPrice }}</strong> </div> </div> <div class="clearfix" /> <h3>Asiakastiedot</h3> <store-information-form @update="updateInfo" :data="info" :messages="messages" /> <span class="pull-left"> <button class="btn btn-primary" @click="toStep(0, true)"> <span class="fa fa-chevron-left"/> Tuotteet </button> </span> <span class="pull-right"> <button class="btn btn-primary" @click="toStep(2, true)"> Maksutapa <span class="fa fa-chevron-right"/> </button> </span> </div> <div v-if="step === 2" class="store-summary form-horizontal"> <div class="row"> <div class="col-lg-6"> <h3>Ostoskori</h3> <store-cart-item v-for="item in cart" :read-only="true" :item="item" :changeItemCount="changeItemCount" :removeItemFromCart="removeItemFromCart" /> <div class="pull-right cart-total"> Yhteensä: <strong>{{ totalPrice | formatPrice }}</strong> </div> <div class="clearfix" /> </div> <div class="col-lg-6"> <h3>Tilaajan tiedot</h3> <store-order-summary :data="info" :messages="messages" /> </div> </div> <div class="row" v-if="!paymentURL"> <div class="col-sm-12"> <h3>Maksutavan valinta</h3> <div class="form-group"> <label class="col-sm-4 control-label">Maksutapa</label> <div class="col-sm-8"> <select class="form-control" v-model="paymentMethod"> <option v-for="method in paymentMethods" v-bind:value="method.id"> {{ method.name }} </option> </select> </div> </div> </div> </div> <div class="row" v-if="paymentURL"> <div class="col-sm-12"> <div class="alert alert-success"> <span class="fa fa-check" /> Tilaus vastaanotettu! Uudelleenohjataan maksupalveluun. Jos mitään ei tapahdu, käytä <a :href="paymentURL">tätä linkkiä</a>. </div> </div> </div> <span class="pull-left"> <button class="btn btn-primary" @click="toStep(1, true)" :class="{ 'disabled': !canMoveToStep(1) }"> <span class="fa fa-chevron-left"/> Asiakastiedot </button> </span> <span class="pull-right"> <button class="btn btn-primary" @click="submit"> <span v-if="!submitting" class="fa fa-fw fa-check" /> <span v-if="submitting" class="fa fa-fw fa-pulse fa-spinner" /> Lähetä tilaus </button> </span> </div> <div class="clearfix" /> </div>`,k=[{id:1,name:"Paytrail verkkomaksu"}],I=[{id:-1,name:"Ei maksua"}];function _(){const t=["format=json"];return location.search&&t.push(location.search.slice(1)),c("GET","/api/v1/store_items/?"+t.join("&"))}function m(t){return c("POST","/api/v1/store_transaction/?format=json",t)}function n(){$("html,body").animate({scrollTop:$(".store").offset().top},500)}r.filter("formatPrice",v),new r({el:"#store",data:{step:0,products:[],cart:[],messages:{},loadingStatus:"loading",info:{first_name:"",last_name:"",email:"",email2:"",street:"",postal_code:"",city:"",country:"fi",mobile:"",telephone:"",company:"",information:"",read_terms:!1},paymentMethod:1,customerInfoIsValid:!1,paymentURL:null,submitting:!1},template:y,created(){_().then(t=>{t.forEach(e=>{e.price=parseFloat(e.price)}),this.products=t,this.loadingStatus="done"}).catch(t=>{console.error("error fetching store items:",t),this.loadingStatus="error"})},computed:{paymentMethods(){return this.totalPrice<=0?I:k},totalPrice(){let t=0;return this.cart.forEach(e=>{t+=this.getSubtotal(e)}),t}},methods:{canMoveToStep(t){if(this.paymentURL!==null||this.submitting)return t===2;let e=!0;return t>0&&(e=e&&this.cart.length>0),t>1&&(e=e&&this.customerInfoIsValid),e},toStep(t,e){if(this.paymentURL===null)if(this.step===0){if(this.cart.length<1){this.messages={items:["Valitse ainakin yksi tuote."]};return}this.messages={},this.step=t,e&&n()}else if(this.step===1&&t===2){const{info:s}=this;if(s.email!==s.email2){this.messages={email:["Kirjoita sama sähköpostiosoite kahdesti."],email2:["Kirjoita sama sähköpostiosoite kahdesti."]};return}let a=this.getTransactionObject();a.save=!1,m(a).then(i=>{this.messages={},this.step=t,this.customerInfoIsValid=!0,e&&n()}).catch(i=>{this.messages=i})}else this.messages={},this.step=t,e&&n()},updateInfo(){this.customerInfoIsValid=!1},getSubtotal(t){let e=1,s=t.product.discount_amount,a=(100-t.product.discount_percentage)/100;return s&&t.count>=s&&(e*=a),t.product.price*t.count*e},updateCart(){const{totalPrice:t}=this;t<=0?this.paymentMethod=-1:this.paymentMethod===-1&&t>0&&(this.paymentMethod=1)},addItem(t,e){if(this.paymentURL!==null)return;let s=this.cart.findIndex(a=>l(a,t,e));if(s>=0){let a=this.cart[s];this.changeItemCount(a,1)}else t.num_available>0&&(this.cart.push({count:1,product:t,variant:e}),this.updateCart())},removeItem(t,e){if(this.paymentURL!==null)return;let s=this.cart.findIndex(a=>l(a,t,e));s>=0&&this.changeItemCount(this.cart[s],-1)},removeItemFromCart(t){if(this.paymentURL!==null)return;let e=this.cart.indexOf(t);this.cart.splice(e,1),this.updateCart()},changeItemCount(t,e){if(this.paymentURL!==null)return;let s=this.cart.indexOf(t),a=this.cart[s],i=a.count+e;if(i>a.product.num_available&&(i=a.product.num_available),i>a.product.max_per_order&&(i=a.product.max_per_order),i<=0){this.removeItemFromCart(a);return}a.count=i,this.cart.splice(s,1,a),this.updateCart()},getTransactionObject(){let t=Object.assign({},this.info);return t.items=this.cart.map(e=>({item_id:e.product.id,variant_id:e.variant?e.variant.id:null,amount:e.count})),t.payment_method=this.paymentMethod,t},submit(){if(this.paymentURL!==null||this.submitting)return;let{info:t}=this,e=this.getTransactionObject();return e.save=!0,this.submitting=!0,m(e).then(s=>{console.info(s),this.submitting=!1,this.paymentURL=s.url,window.location.replace(this.paymentURL)},s=>{this.messages=s,this.submitting=!1,s&&(s.email2=s.email)}).catch(s=>{console.error(s)})}}})})(Vue);
